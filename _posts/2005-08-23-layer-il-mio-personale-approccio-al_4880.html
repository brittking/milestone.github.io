---
layout: post
title: Layer, il mio personale approccio al problema (Parte II)
date: '2005-08-23T21:40:00.002+02:00'
author: Mauro Servienti
tags:
- Why not...
modified_time: '2012-01-25T21:24:52.880+01:00'
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-1485355634421005666
blogger_orig_url: http://milestone.topics.it/2005/08/layer-il-mio-personale-approccio-al_4880.html
permalink: /2005/08/layer-il-mio-personale-approccio-al_4880.html
---

<span>In questa seconda parte (<a title="" href="http://blogs.ugidotnet.org/topics/articles/25039.aspx" target="" name="">qui</a> la prima) completerò la parte applicativa introducendo lo strato 
di factory e cercherò di fare un'analisi, spero oggettiva, del laro svolto dei 
sui limiti e presenterò alcune soluzioni a questi limiti.</span><br>
<span><strong>Factory Layer<br></strong>Nella mia ottica il <em>factory</em> si 
occupa solo ed esclusivamente della generazione delle istanze delle classi di 
business, il factory conosce molto bene lo strato di business. Partiamo, come 
sempre, dal codice che non differisce molto da quello presentato nel <a title="" href="http://blogs.ugidotnet.org/topics/articles/25039.aspx" target="" name="">precedente articolo</a> riguardo allo strato di persistenza:</span><br>
<div style="BORDER-RIGHT: black 1px solid; PADDING-RIGHT: 5px; BORDER-TOP: black 1px solid; PADDING-LEFT: 5px; PADDING-BOTTOM: 5px; BORDER-LEFT: black 1px solid; PADDING-TOP: 5px; BORDER-BOTTOM: black 1px solid; BACKGROUND-COLOR: gainsboro"><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//<br>// ASSEMBLY<br>// Topics.Common.Factory.dll<br>//<br><br></span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public sealed class </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">FactoryEngine<br>{<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">private </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">FactoryEngine()<br>    {<br>    <br>    }<br><br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">private static </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">FactoryEngine _engine;<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">/*<br>        Singleton<br>    */<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public static </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">FactoryEngine Engine<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">get<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">{<br>            </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">if</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">( _engine == </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">null </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">)<br>            {<br>                _engine = </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">new </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">FactoryEngine();<br>            }<br>            <br>            </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">return </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">_engine;<br>        }<br>    }<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">private </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomerFactory _myCustomers<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomerFactory MyCustomers<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">get<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">{<br>            </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">if</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._myCustomers == </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">null </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">)<br>            {<br>                </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._myCustomers = MyCustomerFactory.CreateInstance();<br>            }<br>            <br>            </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">return this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._myCustomers;<br>        }<br>    }<br>}<br><br></span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public abstract class </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomerFactory<br>{<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public static </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomerFactory CreateInstance()<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">/*<br>            OMISSIS<br>            Legge da file .config quale tipo di<br>            Factory debba istanziare e da quale<br>            assembly, tramite Activator.CreateInstance( ... )<br>            inizializza la classe "reale" corretta<br>        */<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">}<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">/*<br>        MyCustomerCollection (omissis) è una semplice <br>        collection fortemente tipizzata di MyCustomers<br>    */<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public abstract </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomerCollection FindCustomersByCompanyName( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">string </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">companyName );<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public abstract </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomer FindByGuid( Guid pk );<br>}<br><br></span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//<br>// ASSEMBLY<br>// Topics.MyApplication.SqlFactory.dll<br>//<br><br></span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public class </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomerSqlFactory : MyCustomerFactory<br>{<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public override </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomerCollection FindCustomersByCompanyName( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">string </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">companyName )<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//Si connette a SQL<br>        <br>        //Invoca la SP del caso<br>        <br>        //Ottiene un SqlDataReader (IDataReader)<br>        <br>        //Crea la collection passando al costruttore il DataReader<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">}<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public override </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomer FindByGuid( Guid pk )<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//Si connette a SQL<br>        <br>        //Invoca la SP del caso<br>        <br>        //Ottiene un SqlDataReader (IDataReader)<br>        <br>        //Crea l'istanza della classe passando al costruttore il DataReader<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">}<br>}<br></span></div>
<span>Anche qui vale la stessa regola esposta per lo strato di persistenza, 
possiamo sostituire il tipo factory a <u>caldo</u> senza che l'applicazione 
debba essere ricompilata, un semplicistico esempio potrebbe essere:</span><br>
<div style="BORDER-RIGHT: black 1px solid; PADDING-RIGHT: 5px; BORDER-TOP: black 1px solid; PADDING-LEFT: 5px; PADDING-BOTTOM: 5px; BORDER-LEFT: black 1px solid; PADDING-TOP: 5px; BORDER-BOTTOM: black 1px solid; BACKGROUND-COLOR: gainsboro"><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public class </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomerRemotingFactory : MyCustomerFactory<br>{<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public override </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomerCollection FindCustomersByCompanyName( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">string </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">companyName )<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">/*<br>            Si connette a Server remoto, dove probabilmente<br>            sta girando un servizio che espone un interfaccia<br>            per recuperare gli oggetti necessari<br>        */<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">}<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public override </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomer FindByGuid( Guid pk )<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//...<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">}<br>}<br></span></div>
<span>La parte di codice si conclude qui (forse), da quello che abbiamo visto sino 
ad ora possiamo cominciare a trarre una prima considerazione, la struttura che 
abbiamo realizzato rispetta un sanissimo principio della strutturazione a layer 
di un'applicazione:</span><br>
<span>Ogni <em>Layer</em> conosce il Layer direttamente sotto di lui ma 
<u>non</u> conosce in nessun modo il Layer che lo consuma.</span><br>
<span>Un primo "limite" che è doveroso sottolineare è che per far si che il 
factory/persistance stiano in assembly diversi da quello del domain, al fine di 
garantire la sostituzione a caldo, i costruttori delle classi di business devono 
essere pubblici, cosa che personalmente non mi paice molto, ma tant'è...</span><br>
<span>Evolvendo la struttura della classe di business presentata, arricchendola 
quindi con qualche informazione in più, salta subito all'occhio un problema non 
indifferente:</span><br>
<div style="BORDER-RIGHT: black 1px solid; PADDING-RIGHT: 5px; BORDER-TOP: black 1px solid; PADDING-LEFT: 5px; PADDING-BOTTOM: 5px; BORDER-LEFT: black 1px solid; PADDING-TOP: 5px; BORDER-BOTTOM: black 1px solid; BACKGROUND-COLOR: gainsboro"><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public class </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomer : MyObject<br>{<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//...<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">private </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyOrderCollection _orders;<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyOrderCollection Orders<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">get<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">{<br>            </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//LazyLoad<br>            </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">if</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._orders == </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">null </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">)<br>            {<br>                </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._orders = ....<br>            }<br>            <br>            </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">return this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._orders; <br>        }<br>    }<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//...<br></span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">}<br></span></div>
<span>Oggiungiamo alla ns classe MyCustomer una proprietà pubblica che rappresenta 
gli ordini fatti da quel particolare cliente, salta subito all'occhio che ci 
troviamo di fronte a 2 grossi problemi:</span><br>
<ul>
  <li>Se MyCustomer carica direttamente gli ordini senza 
  passare da un factory vanifichiamo tutto il lavoro fatto per separare i Layer, 
  perchè il cambiamento di Factory ci imporrebbe di riscrivere questa parte di 
  codice per adeguarla al nuovo factory; 
  <li>Se diamo a MyCustomer la possibilità di usare il factory contraveniamo 
  innanzitutto al principio esposto in precedenza e soprattutto creiamo un 
  riferimento circolare;</li></li></ul>
<span>La soluzione è venuta (come al solito) da internet, sul blog di <a title="" href="http://blogs.aspitalia.com/sm15455" target="" name="">Stefano 
Mostarda</a>, che ha affrontato una problematica pressochè identica.<br>Seguendo 
la sua scelta ho reimplementato la proprietà Orders nel seguente modo, 
trasformandola però in un metodo:</span><br>
<div style="BORDER-RIGHT: black 1px solid; PADDING-RIGHT: 5px; BORDER-TOP: black 1px solid; PADDING-LEFT: 5px; PADDING-BOTTOM: 5px; BORDER-LEFT: black 1px solid; PADDING-TOP: 5px; BORDER-BOTTOM: black 1px solid; BACKGROUND-COLOR: gainsboro"><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public class </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomer : MyObject<br>{<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//...<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">private </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyOrderCollection _orders;<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public event </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">OrdersLazyLoadEventHandler OrdersLazyLoad = </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">null</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">;<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">private void </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">OnOrdersLazyLoad( OrdersLazyLoadEventArgs e )<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">if</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">( OrdersLazyLoad != </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">null </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">)<br>        {<br>            OrdersLazyLoad( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">, e );<br>        }<br>    }<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyOrderCollection GetOrders()<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">get<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">{<br>            </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//LazyLoad<br>            </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">if</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._orders == </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">null </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">)<br>            {<br>                OrdersLazyLoadEventArgs args = </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">new </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">OrdersLazyLoadEventArgs();<br>                </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">.OnOrdersLazyLoad( args );<br>                </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._orders = args.Result;<br>            }<br>            <br>            </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">return this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._orders; <br>        }<br>    }<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//...<br></span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">}<br><br></span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public delegate void </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">OrdersLazyLoadEventHandler( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">object </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">sender, OrdersLazyLoadEventArgs e );<br><br></span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public class </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">OrdersLazyLoadEventArgs : EventArgs<br>{<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">OrdersLazyLoadEventArgs()<br>    {<br>    <br>    }<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">private </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyOrderCollection _result;<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyOrderCollection Result<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">get</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">{ </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">return this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._result; }<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">set</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">{ </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._result = </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">value</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">; }<br>    }<br>}<br></span></div>
<span>A questo punto l'unica accortezza è che il factory sottoscriva l'evento per 
sapere quando qualcuno cerca di accdere alla collection "Orders", quindi il 
factory diventa una cosa del tipo:</span><br>
<div style="BORDER-RIGHT: black 1px solid; PADDING-RIGHT: 5px; BORDER-TOP: black 1px solid; PADDING-LEFT: 5px; PADDING-BOTTOM: 5px; BORDER-LEFT: black 1px solid; PADDING-TOP: 5px; BORDER-BOTTOM: black 1px solid; BACKGROUND-COLOR: gainsboro"><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public class </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomerSqlFactory : MyCustomerFactory<br>{<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">void </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">Wire( MyCustomer item )<br>    {<br>        item.OrdersLazyLoad += </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">new </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">OrdersLazyLoadEventHandler( Customer_OrdersLazyLoad );<br>    }<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">void </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">Unwire( MyCustomer item )<br>    {<br>        item.OrdersLazyLoad -= </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">new </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">OrdersLazyLoadEventHandler( Customer_OrdersLazyLoad );<br>    }<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">void </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">Customer_OrdersLazyLoad( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">object </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">sender, OrdersLazyLoadEventArgs e )<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//Chiama il factory degli ordini per ottenere quelli del sender...<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">e.Result = ...<br>    }<br><br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public override </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomerCollection FindCustomersByCompanyName( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">string </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">companyName )<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//Si connette a SQL<br>        <br>        //Invoca la SP del caso<br>        <br>        //Ottiene un SqlDataReader (IDataReader)<br>        <br>        //Crea la collection passando al costruttore il DataReader<br>        <br>        /*<br>            Lo stesso meccanismo è gestito anche dalla collection<br>            che aggancia l'evento per ognuno degli item e a sua volta<br>            lo "rincula" all'eterno<br>        */<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">.Wire( </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">/* loadedInstance */ </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">);<br>    }<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public override </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyCustomer FindByGuid( Guid pk )<br>    {<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//Si connette a SQL<br>        <br>        //Invoca la SP del caso<br>        <br>        //Ottiene un SqlDataReader (IDataReader)<br>        <br>        //Crea l'istanza della classe passando al costruttore il DataReader<br>        <br>        </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">.Wire( </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">/* loadedInstance */ </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">);<br>    }<br>}<br><br></span></div>
<span><br>Questo approccio apre lo scenario a svariate possibilità tra cui ad 
esempio il caricamento asincrono dei dati cosa che con una proprietà sarebbe 
impossibile, o la possibilità di forzare il reload dei dati senza inquinare la 
classe di business con strani metodi del tipo "InvalidateOrders()".</span><br>
<div style="BORDER-RIGHT: black 1px solid; PADDING-RIGHT: 5px; BORDER-TOP: black 1px solid; PADDING-LEFT: 5px; PADDING-BOTTOM: 5px; BORDER-LEFT: black 1px solid; PADDING-TOP: 5px; BORDER-BOTTOM: black 1px solid; BACKGROUND-COLOR: gainsboro"><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">delegate </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyOrderCollection MyOrderCollectionAsyncLoadDelegate( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">bool </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">invalidate );<br><br></span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">IAsyncResult BeginGetOrders( System.AsyncCallback callback )<br>{<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">return this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">.BeginGetDocuments( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">false</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">, callback );<br>}<br><br></span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">IAsyncResult BeginGetOrders( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">bool </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">invalidate, System.AsyncCallback callback )<br>{<br>    MyOrderCollectionAsyncLoadDelegate handler = </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">new </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyOrderCollectionAsyncLoadDelegate( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">.GetOrders );<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">return </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">handler.BeginInvoke( invalidate, callback, </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">null </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">);<br>}<br><br></span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyOrderCollection EndGetOrders( IAsyncResult result )<br>{<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">if</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">( result.IsCompleted )<br>    {<br>        AsyncResult aRes = result </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">as </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">AsyncResult;<br>        MyOrderCollectionAsyncLoadDelegate handler =  aRes.AsyncDelegate </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">as </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyOrderCollectionAsyncLoadDelegate;<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._myOrders = handler.EndInvoke( result ) </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">as </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyOrderCollection;<br>    }<br><br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">return this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._myOrders;<br>}<br><br></span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyOrderCollection GetOrders()<br>{<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">return this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">.GetOrders( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">false </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">);<br>}<br><br></span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">public </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">MyOrderCollection GetOrders( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">bool </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">invalidate )<br>{<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #008000; FONT-FAMILY: Courier New">//LazyLoad o se c'è richiesta di reload<br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">if</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">( </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._orders == </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">null </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">|| invalidate )<br>    {<br>        OrdersLazyLoadEventArgs args = </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">new </span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">OrdersLazyLoadEventArgs();<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">.OnOrdersLazyLoad( args );<br>        </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._orders = args.Result;<br>    }<br>    <br>    </span><span style="FONT-SIZE: 10pt; COLOR: #0000ff; FONT-FAMILY: Courier New">return this</span><span style="FONT-SIZE: 10pt; COLOR: #000000; FONT-FAMILY: Courier New">._orders; <br>}</span></div>
<span>Il codice esposto in questi due articoli è 
fondamentalment codice "real world" anche se ampiamente rimaneggiato per adattarlo al 
contesto.</span><br>
<span>Disponibile per qualsiasi chiarimento e/o approfondimento vi invito ad 
utilizzare il form contact o a lasciare un commento.</span><br>
<span><em>.m</em></span><br>

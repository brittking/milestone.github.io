---
layout: post
title: NServiceBus endpoints aggregation
date: '2014-04-01T12:36:00.001+02:00'
author: Mauro Servienti
tags:
- NServiceBus
modified_time: '2014-04-01T12:36:16.927+02:00'
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-4207699604824197079
blogger_orig_url: http://milestone.topics.it/2014/04/nservicebus-endpoints-aggregation.html
---

<p>When developing a distributed solution using <a href="http://particular.net/" target="_blank">NServiceBus</a> one the usual caveat is that you end up with tons of projects in the solution just to mimic the deployment topology of the production environment.</p> <blockquote> <p>note: it is not a NServiceBus issue, it is in the nature of the distributed development process.</p></blockquote> <p>Currently there is an <a href="https://github.com/Particular/NServiceBus/issues/1357" target="_blank">open issue</a>, in the GitHub repository, followed by an interesting discussion where the core of the issue is a request to support multiple endpoints in the same host, hosting each endpoint in a different AppDomain so to have per endpoint configuration.</p> <p><strong>Do we really need it?</strong></p> <p>I mean: do we really need different configurations for each endpoint? my general answer is that at development time this is generally not a real issue. Why am I focusing on the development time? because if you dive into the above discussion what emerges is that the annoying issue is having too many processes that start, and that need to be maintained, during the development process.</p> <p><strong>So?</strong></p> <p>The new question now is: can we, on the developer machine, merge everything down in a single host process? if configurations can be “merged”, without generating conflicting configurations, the answer is simply yes.</p> <p><strong>How?</strong></p> <p>The first thing is to understand what happens when we bootstrap the bus via the NServiceBus configuration API or using an EndpointConfig class. NServiceBus scans all the assemblies looking for message handlers, sagas and classes that implements NServiceBus configuration interfaces, such as but not only, IConfigureThisEndpoint.</p> <p>Given the fact that all this process is done via reflection looking in the “bin” folder what prevents us to:</p> <ul> <li>Create a dummy class library project that will be used only on the developers machines;</li> <li>Add a reference via NuGet to the <a href="https://www.nuget.org/packages/NServiceBus.Host" target="_blank">NServiceBus.Host</a> package;</li> <li>Define our endpoints and sagas and all the rest related to the business logic in another, or lots of them as per the deployment topology, class library project;</li> <li>Add a reference to the business logic into the dummy host project;</li> <li>Define all the configuration in the config file of the dummy project;</li> <li>Run the dummy project on the developer machine;</li></ul> <p>In the end we can think about hosts only as aggregation services whose only role is to give us all the plumbing required to live in the operating system that is hosting us. All what we need now are a bunch of scripts and config transforms that can split down pieces to prepare segmented hosts to be deployed in production.</p> <p>We are currently using the above approach to manage a pretty complex solution that in production is deployed into 16 different windows services, on several machines, but on the developers machines is made of 3 dummy hosts, why 3 and not 1? configurations :-) we aggregated all the endpoints that conceptually share the same configuration, ending up with 3 main groups.</p> <p>.m</p>  
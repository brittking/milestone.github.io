---
layout: post
title: NServiceBus high load performance tricks
date: '2013-07-09T10:49:00.000+02:00'
author: Mauro Servienti
tags:
- Domain Driven Design
- Software Mason
- NServiceBus
modified_time: '2013-07-09T10:49:00.109+02:00'
thumbnail: http://lh3.ggpht.com/-5Pn0rMoArhI/Udp3pco_sRI/AAAAAAAACaI/ya3fc-VrKHM/s72-c/image_thumb1.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-988322385833191884
blogger_orig_url: http://milestone.topics.it/2013/07/nservicebus-high-load-performance-tricks.html
permalink: /2013/07/nservicebus-high-load-performance-tricks.html
---

<p>We have the following pretty complex integration layer to move data from AS400 to a much more confortable structure on MongoDB:</p> <p><a href="http://lh4.ggpht.com/-5C54G6owzWM/Udp3orYfuPI/AAAAAAAACaE/jw4M228jVvo/s1600-h/image3.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://lh3.ggpht.com/-5Pn0rMoArhI/Udp3pco_sRI/AAAAAAAACaI/ya3fc-VrKHM/image_thumb1.png?imgmax=800" width="464" height="247"></a></p> <p>We set it up and deployed in a staging environment to start testing, the first normalization step is out of our control and is periodically run every 15 minutes, currently, but the plan is to move it to a 5 minutes schedule in the future.</p> <p>Everything works fine so we started doing some real testing with some load, so to be able to measure performance and to try to predict what will be the worst scenario in production.</p> <p>Once the first normalization step is completed, for every detected change in the source AS400 a message is pushed in our listening queue (MSMQ), for each message we go back to the source SQL Server, call 3 or 4 (depending on the incoming message) stored procedures, transform data an store them into MongoDB.</p> <p>The whole process, in the not so fast, staging environment takes 238ms per message, at first I thought: pretty good, with all we do processing 4 message per second is not so bad…well, not so bad unless we take a look at how the AS400 production environment behaves during normal operations.</p> <p>The worst case we observed is something internally called “massive update” (it is not so hard to understand what the scenario is):</p> <ul> <li>A guy on the AS400 side does something on the system that changes 200.000 records…;</li> <li>When the first normalization step runs we will have 200.000 messages pushes in a bunch of seconds to our queue;</li> <li>4msgs/sec == 50.000 sec == 834 minutes == 13 hours…;</li> <li>WTF…the next refresh of the first normalization step will be 12 hours and 45 minutes before we can handle it…</li></ul> <p>It is a no go, period.</p> <p>We started doing some performance investigation and, to make a long story short, we discovered that:</p> <ul> <li>The DTC was taking the 30% of that time, but we can get rid of the DTC because we have in the incoming message enough information to run our de-duplication logic and our ordering logic;</li> <li>The logging infrastructure was consuming the 80% of the handling time, yes the 80% percent;</li></ul> <p>So, disabling the DTC and tuning the logging infrastructure using setting the logging level to WARN and carefully adjusting what we emit to the log, we moved from 238ms per message to 38ms per message, not so bad as a performance gain, isn’t it?</p> <p>So now we have:</p> <ul> <li>26msgs/sec == 7.700 sec == 128 minutes == 2 hours</li></ul> <p>it is still not enough to face a “massive update” on a 5 minutes window, but now we can introduce some more logic that:</p> <ul> <li>handle the incoming message and the first consideration will be: is the changed element older than one year?</li> <ul> <li>No: handle it immediately, we care for it;</li> <li>Yes: defer it for later, or forward it to a low priority service, we are definitely interested in the reported change but since the change affect some old record we can process it later, without any hurry;</li></ul></ul> <p>And given the above conditions we can safely say that even in case of a “massive update” we can react properly, may our processing time won’t be within the 5 minutes window, but since massive updates are not something that happens daily we can tolerate it.</p> <p>.m</p>  

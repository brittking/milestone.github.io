---
layout: post
title: 'RavenDB: first contact'
date: '2012-02-06T10:10:00.000+01:00'
author: Mauro Servienti
tags:
- Software Mason
- RavenDB
modified_time: '2012-02-06T10:10:00.744+01:00'
thumbnail: http://lh4.ggpht.com/-lt7eeU6XANM/TyqPG-X-CNI/AAAAAAAAAr4/0rYXTkvpo2Y/s72-c/image_thumb1.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-2213690819690820923
blogger_orig_url: http://milestone.topics.it/2012/02/ravendb-first-contact.html
permalink: /2012/02/ravendb-first-contact.html
---

<p>We have seen how to <a href="http://mauroservienti.blogspot.com/2012/01/ravendb-start-your-engines.html" target="_blank">setup the development</a> environment to use <a href="http://ravendb.net/" target="_blank">RavenDB</a>, obviously the next step is to try to use our brand new environment.</p>  <p><a href="http://nuget.org" target="_blank"><strong>NuGet</strong></a><strong> to the rescue</strong></p>  <p>First of all let’s setup the Visual Studio project to use RavenDB, using nuget as simple as adding a package reference to the RavenDB nuget package:</p>  <p><a href="http://lh3.ggpht.com/-VKAlD5cX7x4/TyqPGZmftTI/AAAAAAAAArw/8GvT_jhm1MI/s1600-h/image3.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/-lt7eeU6XANM/TyqPG-X-CNI/AAAAAAAAAr4/0rYXTkvpo2Y/image_thumb1.png?imgmax=800" width="306" height="69" /></a></p>  <p><em>Figure: nuget installation dialog</em></p>  <p>the package installation downloads all the required dependencies and setup the application configuration file with the required connection string, that obviously must be adapted to your environment:</p>  <p><a href="http://lh5.ggpht.com/-aKaemUvnWYg/TyqPH63b1eI/AAAAAAAAAr8/AKsht-munR8/s1600-h/image19.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/--WAAVPwU3Gc/TyqPIT_EJiI/AAAAAAAAAsE/nJDkFzMjAD0/image_thumb9.png?imgmax=800" width="310" height="50" /></a></p>  <p><em>Figure: the application configuration file customized for my environment, where RavenDB server listen on port 81</em></p>  <p><strong>The basics</strong></p>  <p>RavenDB has 2 main building block that must be understood in order to manage all the features, having had previous experience with NHibernate can help in this area because the RavenDB API has been designed to help ORM users to migrate and stay in well known environment.</p>  <p><strong>IDocumentStore</strong></p>  <p>The IDocumentStore interface is the counterpart, for ORM users, of the NHibernate ISessionFactory there should (we’ll see in future posts why “should” and not <em>must</em>) be one document store per each RavenDB server we need to access.</p>  <p><a href="http://lh6.ggpht.com/-ioK0NHYW7YM/TyqPI33o8BI/AAAAAAAAAsQ/Z-6I4oCxtQE/s1600-h/image11.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/-GfLHVY2_qqM/TyqPJ-lm6jI/AAAAAAAAAsY/HUeJQW6fcVw/image_thumb5.png?imgmax=800" width="262" height="120" /></a></p>  <p><em>Figure: the creation and initialization of the document store</em></p>  <p>the document store has several properties that we can use to customize the behavior of the connection, the security and the behavior of the store itself.</p>  <p>The only really required thing to do is to initialize, once, the store calling the quite obvious “Initialize” method.</p>  <p><strong>IDocumentSession</strong></p>  <p>the document session interface, that mimics the NHibernate ISession behaviors, is the entry point to access data stored on a RavenDB server instance. The document session is also our “Unit Of Work” implementation that let us manage business transactions against the server.</p>  <p>Connection to a database is as easy as:</p>  <p><a href="http://lh4.ggpht.com/-B89DzITVAQE/TyqPKrSrOVI/AAAAAAAAAsc/munvnbHz1Ig/s1600-h/image15.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/-RAipPP58bNE/TyqPLLHpl6I/AAAAAAAAAsk/iFRtoCVIcV0/image_thumb7.png?imgmax=800" width="266" height="54" /></a></p>  <p><em>Figure: the creation of a document session</em></p>  <p>where “myMusic” is the name of the database where I created the sample data, if we do not specify the database name the connection will be made against the default database (that always exists) or against the default database specified before the document store initialization using the DefaultDatabase property (we can also specify the default database in the connection string.</p>  <p><strong>So far so good…so what?</strong></p>  <p>…let’s try to pick some data…just try:</p>  <p><a href="http://lh6.ggpht.com/-8RrZ6kEngK8/TyqPMu1V7WI/AAAAAAAAAsw/7VIlQcbGS6Q/s1600-h/image23.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh6.ggpht.com/-QjwCpFE1rrk/TyqPOiDxBSI/AAAAAAAAAs4/e8jRa_BaAT8/image_thumb11.png?imgmax=800" width="311" height="151" /></a></p>  <p><em>Figure: some data retrieved in a rather funky way</em></p>  <p>Cool! what’s going on? we have done a really strange thing we have used the generic Query method, closed against a .net 4.0 <em>dynamic</em> type, asking for the first 10 items…and we received back 10 items…not so expected as it can seem at a first look.</p>  <p><strong>A little digression…little, trust me…</strong></p>  <p>In order to figure out what has happened when the above query has been executed we need to understand how data (document) are stored in a document database.</p>  <p>No tables here guys <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="http://lh3.ggpht.com/-M3SYJsqGyts/TyqPPSkfz7I/AAAAAAAAAtA/gMTj3heR2VA/wlEmoticon-smile%25255B2%25255D.png?imgmax=800" />, the above linq query can be compared to the following, invalid, T-SQL statement:</p>  <blockquote>   <p>select top 10 *     <br />go</p> </blockquote>  <p>That obviously has no meaning in a relational world because lacks, al least, the “from &lt;<em>table-name</em>&gt;” clause. Document databases has the concept of collection that represents an homogeneous subset of data and in RavenDB the subset you want to query over is expressed by the .net generic type you choose for the Query method (it is not really true, but for the moment it’s good enough).</p>  <p><strong>Let’s move on</strong></p>  <p>If we take a look at the database using the Raven Management Studio we can see that there are 2 different collections: Albums and Genres.</p>  <p><a href="http://lh5.ggpht.com/-IXf0VSMZD0Y/TyqPQ50He6I/AAAAAAAAAtI/0vD-cRn47v8/s1600-h/image%25255B3%25255D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh6.ggpht.com/-Mbq7r6gAI1A/TyqPSIsXz0I/AAAAAAAAAtQ/yjzsWCf4oTM/image_thumb.png?imgmax=800" width="244" height="77" /></a></p>  <p><em>Figure: collection contained in the database</em></p>  <p>Which is the easiest method to tell to the document session that we want to query the albums collection? remember easiest.</p>  <p>Just define an Album type with the same shape of the json document stored in the database</p>  <p><a href="http://lh3.ggpht.com/-SK5tJNpKERk/TyqPS2NNA0I/AAAAAAAAAtY/Ordy4algwcM/s1600-h/image%25255B15%25255D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh6.ggpht.com/-x0DzTEV1qgw/TyqPUTL-IFI/AAAAAAAAAtg/Wazfrpz8KWI/image_thumb%25255B6%25255D.png?imgmax=800" width="300" height="169" /></a><a href="http://lh5.ggpht.com/-L6645H5CHX0/TyqPVRiFXXI/AAAAAAAAAto/5mNd0WFv72Y/s1600-h/image%25255B16%25255D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/-xFL-NdEkzSE/TyqPWGmtYwI/AAAAAAAAAts/BR7c9kJtAiI/image_thumb%25255B7%25255D.png?imgmax=800" width="214" height="169" /></a></p>  <p><em>Figures: on the left side the Album type definition on the right side the json document that represents an album in the database</em></p>  <p>As you can see we have defined even complex types (AlbumGenre and AlbumArtist, we’ll have future posts to detail the concept of “relation”) that will be automatically mapped to the corresponding nested properties in the json document. One thing you may already have noticed is that the json document is the serialized version of the .net type.</p>  <p><strong>Query</strong></p>  <p>if we rewrite the above query using the Album type we fetch exactly 10 albums:</p>  <p><a href="http://lh6.ggpht.com/-OiVMMvIAaiI/TyqPWo1ttMI/AAAAAAAAAt0/-OYcWNKStqk/s1600-h/image%25255B21%25255D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/-FpYNZx6x80U/TyqPXIiW7PI/AAAAAAAAAt8/QFgskSp8Mss/image_thumb%25255B10%25255D.png?imgmax=800" width="409" height="139" /></a></p>  <p><em>Figure: RavenDB query executed to retrieve 10 albums from the database</em></p>  <p><em>wundershon</em> <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="http://lh3.ggpht.com/-M3SYJsqGyts/TyqPPSkfz7I/AAAAAAAAAtA/gMTj3heR2VA/wlEmoticon-smile%25255B2%25255D.png?imgmax=800" />…but how can RavenDB “map” <strong>our </strong>.net type to its own internal representation? using one of the thousands of cool features that this database have: metadata.</p>  <p><a href="http://lh4.ggpht.com/-9adDwbheY2w/TyqPXnwPsQI/AAAAAAAAAuE/YxMkP_9cSb8/s1600-h/image%25255B26%25255D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/-sC8EsjDQOrw/TyqPYUMxFwI/AAAAAAAAAuM/Tt3teB1pBIw/image_thumb%25255B13%25255D.png?imgmax=800" width="244" height="113" /></a></p>  <p><em>Figure: the same document showing the metadata tab in the management studio.</em></p>  <p>each document has a set of extensible metadata attached to it and the important one in this case is the Raven-Entity-Name, the database engine utilizes a set of conventions to translate a .net type name to the so called “Raven tag name”:</p>  <p><a href="http://lh3.ggpht.com/-LR9xtbLwvR4/TyqPYnyaOQI/AAAAAAAAAuY/lGffyUBLOyI/s1600-h/image%25255B31%25255D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/-MFHK6b8geNU/TyqPZeThUYI/AAAAAAAAAuc/INpCnsD3G0s/image_thumb%25255B16%25255D.png?imgmax=800" width="421" height="67" /></a></p>  <p><em>Figure: using document store conventions to map .net type name to Raven tag name.</em></p>  <p>Enough for this post…next time is time for “storing data” <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="http://lh3.ggpht.com/-M3SYJsqGyts/TyqPPSkfz7I/AAAAAAAAAtA/gMTj3heR2VA/wlEmoticon-smile%25255B2%25255D.png?imgmax=800" /></p>  <p>.m</p>  

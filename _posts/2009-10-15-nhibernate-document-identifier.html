---
layout: post
title: 'NHibernate: document identifier'
date: '2009-10-15T04:15:00.000+02:00'
author: Mauro Servienti
tags:
- Software Mason
modified_time: '2012-02-03T13:02:28.194+01:00'
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-6490916634630856601
blogger_orig_url: http://milestone.topics.it/2009/10/nhibernate-document-identifier.html
---

<span>Lo scenario più semplice è quello della generazione del “numero fattura” in fase di insert del nuovo documento, tralasciamo per ora le più svariate possibilità legate al concetto di bozza, ad un certo punto avete la necessità di generare questo benedetto numero che deve sottostare a determinate regole. La stessa cosa può succedere in altri casi, come ad esempio la generazione di un codice cliente, e questo ci permette di generalizzare dicendo che:</span><br>  <ol>   <li>Abbiamo la necessità di generare un codice univoco;</li>    <li>Questo codice univoco deve essere umanamente leggibile e avere un significato nel mondo reale, quindi niente guid;</li>    <li>Il codice generato deve sottostare a delle regole, come ad esempio:</li>    <ol>     <li>deve essere progressivo, e la progressione potrebbe dipendere dall’uso: numerica, alfabetica, <em>quellochemicipiaceame</em>… :-)</li>      <li>potrebbe avere una logica di reset: il numero fattura si resetta ad inizio anno ad esempio;</li>      <li>etc…</li>   </ol> </ol>  <span>In molti casi si potrebbe addomesticare il tutto con dell’ottimo codice t-sql e siccome non è un male spesso e volentieri lo faccio, del resto la logica di generazione del numero fattura è decisamente banale, ma non è sempre così potreste avere delle casistiche, nel mio caso la generazione del codice cliente, in cui non è proprio banale far girare l’algoritmo in codice t-sql.</span><br>  <span>In che modo <a href="https://www.hibernate.org/343.html">NHibernate</a> ci può essere di aiuto? da questa necessità è nato un <a href="http://groups.google.com/group/nh-it/browse_frm/thread/ed8a100f8a4b419c#">thread</a>, con <a href="http://fabiomaulo.blogspot.com/">Fabio Maulo</a>, sullo <a href="http://groups.google.com/group/nh-it">user group italiano</a> di NHibernate.</span><br>  <span>Fabio propone di:</span><br>  <ul>   <li>definire la logica di generazione come entità di dominio;</li>    <li>definire nello schema del db una tabella che ospita le caratteristiche di questa logica:</li>    <ul>     <li>ad esempio ultimo numero generato e data di generazione dell’ultimo numero, nel caso di una fattura;</li>   </ul>    <li> in fase di insert</li>    <ul>     <li>caricare da db questa entità;</li>      <li>chiederle di generare un nuovo id;</li>      <li>eseguire l’update, del “generatore”, e l’insert della nuova entità, ad esempio la fattura, con un lock;</li>   </ul> </ul>  <span>Adesso la domanda che sorge spontanea, e che ho inevitabilmente ribaltato al <a href="http://blogs.ugidotnet.org/pape">capo</a>, è: ma sta roba la delego al dev che si occupa del processo di insert o deve essere implicita e quindi automatica?</span><br>  <span>A mio modo di vedere questo è uno di quei problemi molto borderline da un lato la logica di generazione del “numero documento” è logica di business ma dall’altro è strettamente dipendendente dallo storage e il boss propone di automatizzare questo giro, ergo una possibilità sono gli <a href="http://knol.google.com/k/fabio-maulo/nhibernate-chapter-11/1nr4enxv3dpeq/14">eventi di NHIbernate</a> per inserirsi nella pipeline di salvataggio e a questo punto fare il bello e cattivo tempo.</span><br>  <span>.m</span><br>
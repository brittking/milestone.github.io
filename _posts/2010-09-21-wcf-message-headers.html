---
layout: post
title: WCF Message Headers
date: '2010-09-21T07:27:00.000+02:00'
author: Mauro Servienti
tags:
- Software Mason
- Wcf
modified_time: '2012-02-20T12:19:49.942+01:00'
thumbnail: https://lh4.googleusercontent.com/-G6h1dIj7ygY/T0IsU9haLqI/AAAAAAAABsA/bnIjs7CJop8/s72-c/wlEmoticon-smile_2_10.png
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-765400221021620813
blogger_orig_url: http://milestone.topics.it/2010/09/wcf-message-headers.html
permalink: /2010/09/wcf-message-headers.html
---

<span>Un servizio è un componente come tanti e come tutti i componenti espone un contratto, questa cosa per inciso è decisamente eplicita in WCF che separa nettamente contratto e implementazione.</span><br>  <span>In generale trovo poco sensato che nel contratto vengano esplicitati elementi (tipicamente parametri) che hanno poco a che spartire con il contratto ma sono decisamente più legati alla tecnologia implementativa.</span><br>  <span>Un esempio potrebbe essere, ad esempio, questo:</span><br>  <blockquote>   <pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><font style="font-size: 12pt">[</font><span><font style="font-size: 12pt" color="#2b91af">ServiceContract</font></span><font style="font-size: 12pt">]</font></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#0000ff">interface</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">ISearchService</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">{</font></font><br><font face="Consolas"><font style="font-size: 12pt">	[</font><span><font style="font-size: 12pt" color="#2b91af">OperationContract</font></span><font style="font-size: 12pt">( Name = </font><span><font style="font-size: 12pt" color="#a31515">"FindBranchesByQuery"</font></span><font style="font-size: 12pt"> )]</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#2b91af">BranchDto</font></span><font style="font-size: 12pt">[] FindBranches( <span><font style="font-size: 12pt" color="#2b91af">String</font></span><font style="font-size: 12pt"> culture,</font> </font><span><font style="font-size: 12pt" color="#2b91af">BranchesSearchQueryDto</font></span><font style="font-size: 12pt"> queryDto );</font></font><br><font face="Consolas"><font style="font-size: 12pt">}</font></font></pre>
</blockquote>

<span>ora… il primo parametro è stato esposto dal contratto del servizio perchè il client deve in qualche modo dire al servizio quale sia la culture del chiamante, ma nel caso specifico è un design sbagliato e legato all’implementazione e non al requisito perchè nei requisiti non c’è che il client possa visualizzare informazioni in una lingua diversa da quella corrente, nel qual caso avrebbe senso, ergo questo:</span><br>

<blockquote>
  <pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><font style="font-size: 12pt">[</font><span><font style="font-size: 12pt" color="#2b91af">ServiceContract</font></span><font style="font-size: 12pt">]</font></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#0000ff">interface</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">ISearchService</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">{</font></font><br><br><font face="Consolas"><font style="font-size: 12pt">	[</font><span><font style="font-size: 12pt" color="#2b91af">OperationContract</font></span><font style="font-size: 12pt">( Name = </font><span><font style="font-size: 12pt" color="#a31515">"FindBranchesByQuery"</font></span><font style="font-size: 12pt"> )]</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#2b91af">BranchDto</font></span><font style="font-size: 12pt">[] FindBranches( </font><span><font style="font-size: 12pt" color="#2b91af">BranchesSearchQueryDto</font></span><font style="font-size: 12pt"> queryDto );</font></font><br><font face="Consolas"><font style="font-size: 12pt">}</font></font></pre>
</blockquote>

<span>è decisamente più lineare. A questo punto si pone però il problema di come passare le informazioni accessorie…</span><br>

<span><strong>Header</strong>(s)</span><br>

<span>Da che mondo è mondo i servizi supportano il concetto di MessageHeader, quando usiamo WCF da Visual Studio abbiamo una visione molto limitata di quello che in realtà succede dietro le quinte perchè l’infrastruttura di WCF fa di tutto per renderci la vita facile, però come sappiamo WCF è tutto tranne che chiamate a metodi remoti, in realtà WCF è messaggi che viaggiano tra il client e il server e viceversa e questi messaggi hanno una struttura ben precisa che come minimo è formata da:</span><br>

<ul>
  <li>una <em>envelope</em>;</li>

  <ul>
    <li>un <em>header</em>;</li>

    <li>un <em>body</em>;</li>
  </ul>
</ul>

<span>L’header è la parte che noi non vediamo praticamente mai ma è ricca di funzionalità:</span><br>

<blockquote>
  <pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><font style="font-size: 12pt">[</font><span><font style="font-size: 12pt" color="#2b91af">DataContract</font></span><font style="font-size: 12pt">]</font></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#0000ff">class</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">SearchRequestContext</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">{</font></font><br><font face="Consolas"><font style="font-size: 12pt">	[</font><span><font style="font-size: 12pt" color="#2b91af">DataMember</font></span><font style="font-size: 12pt">( IsRequired = </font><span><font style="font-size: 12pt" color="#0000ff">true</font></span><font style="font-size: 12pt"> )]</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">String</font></span><font style="font-size: 12pt"> TenantIdentifier { </font><span><font style="font-size: 12pt" color="#0000ff">get</font></span><font style="font-size: 12pt">; </font><span><font style="font-size: 12pt" color="#0000ff">set</font></span><font style="font-size: 12pt">; }</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">	[</font><span><font style="font-size: 12pt" color="#2b91af">DataMember</font></span><font style="font-size: 12pt">( IsRequired = </font><span><font style="font-size: 12pt" color="#0000ff">true</font></span><font style="font-size: 12pt"> )]</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">String</font></span><font style="font-size: 12pt"> Culture { </font><span><font style="font-size: 12pt" color="#0000ff">get</font></span><font style="font-size: 12pt">; </font><span><font style="font-size: 12pt" color="#0000ff">set</font></span><font style="font-size: 12pt">; }</font></font><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><br><font face="Consolas"><font style="font-size: 12pt">}</font></font></pre>
</blockquote>

<span>possiamo prendere un qualsiasi DataContract e lo possiamo far viaggiare insieme alla nostra chiamata semplicemente in questo modo:</span><br>

<blockquote>
  <pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> header = </font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">MessageHeader</font></span><font style="font-size: 12pt"><</font><span><font style="font-size: 12pt" color="#2b91af">SearchRequestContext</font></span><font style="font-size: 12pt">>( context );</font></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#2b91af">OperationContext</font></span><font style="font-size: 12pt">.Current.OutgoingMessageHeaders.Add</font></font><br><font face="Consolas"><font style="font-size: 12pt">(</font></font><br><font face="Consolas"><font style="font-size: 12pt">	header.GetUntypedHeader( </font><span><font style="font-size: 12pt" color="#0000ff"><span><font face="Consolas"><font style="font-size: 12pt" color="#a31515">"Header unique name"</font></font></span></font></span><font style="font-size: 12pt">, </font></font><span><font face="Consolas"><font style="font-size: 12pt" color="#a31515">"My namespace"</font></font></span><font face="Consolas"><font style="font-size: 12pt"> )</font></font><br><font face="Consolas"><font style="font-size: 12pt">);</font></font></pre>
</blockquote>

<span>Con l’accortezza di eseguire la chiamata al servizio in un OperationContextScope:</span><br>

<blockquote>
  <pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt">( </font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> client = </font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">SearchServiceClient</font></span><font style="font-size: 12pt">() )</font></font><br><font face="Consolas"><font style="font-size: 12pt">{</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt">( </font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> scope = </font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">OperationContextScope</font></span><font style="font-size: 12pt">( client.InnerChannel ) )</font></font><br><font face="Consolas"><font style="font-size: 12pt">	{</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font></font><br><font face="Consolas"><font style="font-size: 12pt">	}</font></font><br><font face="Consolas"><font style="font-size: 12pt">}</font></font></pre>
</blockquote>

<span>in questo modo ci garantiamo che il ciclo di vita dell’header coincida con quello dello scope al fine di evitare collisioni con chiamate concorrenti.</span><br>

<span>Recuperare un header, ad esempio quando si è sul server o quando dal client si vogliono leggere gli header ritornati dal server, è un filino più complesso (o per meglio dire <em>noioso…</em>):</span><br>

<blockquote>
  <pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt">( </font><span><font style="font-size: 12pt" color="#2b91af">OperationContext</font></span><font style="font-size: 12pt">.Current.IncomingMessageHeaders != </font><span><font style="font-size: 12pt" color="#0000ff">null</font></span><font style="font-size: 12pt"> )</font></font><br><font face="Consolas"><font style="font-size: 12pt">{</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> index = </font><span><font style="font-size: 12pt" color="#2b91af">OperationContext</font></span><font style="font-size: 12pt">.Current.IncomingMessageHeaders.FindHeader( </font><span><font style="font-size: 12pt" color="#a31515">"My header name"</font></span><font style="font-size: 12pt">, </font><span><font style="font-size: 12pt" color="#a31515">"My Namespace"</font></span><font style="font-size: 12pt"> );</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt">( index != -1 )</font></font><br><font face="Consolas"><font style="font-size: 12pt">	{</font></font><br><font face="Consolas"><font style="font-size: 12pt">		</font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> header = </font><span><font style="font-size: 12pt" color="#2b91af">OperationContext</font></span><font style="font-size: 12pt">.Current.IncomingMessageHeaders.GetHeader<</font><span><font style="font-size: 12pt" color="#2b91af">SearchRequestContext</font></span><font style="font-size: 12pt">></font></font><br><font face="Consolas"><font style="font-size: 12pt">		(</font></font><br><font face="Consolas"><font style="font-size: 12pt">			</font><span><font style="font-size: 12pt" color="#a31515">"My header name"</font></span><font style="font-size: 12pt">, </font><span><font style="font-size: 12pt" color="#a31515">"My Namespace"</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">		);</font></font><br><font face="Consolas"><font style="font-size: 12pt">	}</font></font><br><font face="Consolas"><font style="font-size: 12pt">}</font></font></pre>
</blockquote>

<span>ma possiamo lavorare un po’ per semplificare drammaticamente le cose e arrivare ad una cosa come questa:</span><br>

<blockquote>
  <pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> factory = </font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">DefaultClientMessageHeaderManagerFactory</font></span><font style="font-size: 12pt">();</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt">( </font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> client = </font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">SearchServiceClient</font></span><font style="font-size: 12pt">() )</font></font><br><font face="Consolas"><font style="font-size: 12pt">{</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt">( </font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> manager = factory.Create( client.InnerChannel ) )</font></font><br><font face="Consolas"><font style="font-size: 12pt">	{</font></font><br><font face="Consolas"><font style="font-size: 12pt">		</font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> ctx = </font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">SearchRequestContext</font></span><font style="font-size: 12pt">()</font></font><br><font face="Consolas"><font style="font-size: 12pt">		{</font></font><br><font face="Consolas"><font style="font-size: 12pt">			Culture = </font><span><font style="font-size: 12pt" color="#a31515">"it-IT"</font></span><font style="font-size: 12pt">,</font></font><br><font face="Consolas"><font style="font-size: 12pt">			TenantIdentifier = </font><span><font style="font-size: 12pt" color="#a31515">"SampleTenantId"</font></span><font style="font-size: 12pt">,</font></font><br><br><font face="Consolas"><font style="font-size: 12pt">		};</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">		manager.SetHeader( ctx );</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">		</font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> query = </font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af"><em>..Query..</em></font></span><font style="font-size: 12pt">();</font></font><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">		</font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> result = client.FindBranchesByQuery( query );</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">		</font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> inHeaders = manager.GetIncomingHeader<</font><span><font style="font-size: 12pt" color="#2b91af">SearchRequestContext</font></span><font style="font-size: 12pt">>();</font></font><br><font face="Consolas"><font style="font-size: 12pt">	}</font></font><br><font face="Consolas"><font style="font-size: 12pt">}</font></font></pre>
</blockquote>

<span>Figo <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="https://lh4.googleusercontent.com/-G6h1dIj7ygY/T0IsU9haLqI/AAAAAAAABsA/bnIjs7CJop8/wlEmoticon-smile_2_10.png">, il tutto sarà disponibile a breve su <a href="http://radical.codeplex.com/" target="_blank">Radical</a>.</span><br>

<span>Una nota molto importante, questo snippet:</span><br>

<blockquote>
  <pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> header = </font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">SearchRequestContext</font></span><font style="font-size: 12pt">();</font></font><br><font face="Consolas"><font style="font-size: 12pt">manager.SetHeader( header );</font></font><br><font face="Consolas"><font style="font-size: 12pt">header.TenantIdentifier = </font><span><font style="font-size: 12pt" color="#a31515">"Foo"</font></span><font style="font-size: 12pt">;</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> outHeader = manager.GetOutgoingHeader<</font><span><font style="font-size: 12pt" color="#2b91af">SearchRequestContext</font></span><font style="font-size: 12pt">>();</font></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> actual = header.TenantIdentifier == outHeader.TenantIdentifier;</font></font></pre>
</blockquote>

<span>non produce il risultato atteso, non tanto per come funzione l’header manager piuttosto per come funzionano proprio gli header di WCF che vengono immediatamente serizalizzati all’atto dell’aggiunta.</span><br>

<span>.m</span><br>

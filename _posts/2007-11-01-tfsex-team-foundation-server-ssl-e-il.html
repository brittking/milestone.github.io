---
layout: post
title: '[TFS.eX] Team Foundation Server, SSL e il ReverseProxy (ISA 2006)'
date: '2007-11-01T10:53:00.000+01:00'
author: Mauro Servienti
tags:
- Team Foundation Server
modified_time: '2012-01-27T15:43:12.493+01:00'
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-7456700995455882679
blogger_orig_url: http://milestone.topics.it/2007/11/tfsex-team-foundation-server-ssl-e-il.html
---

<span>Dopo un primo tentativo miseramente fallito <img alt="Baring teeth" src="http://messenger.msn.com/MMM2006-04-19_17.00/Resource/emoticons/48_48.gif"> e recuperato in <em>corner</em> grazie agli "<em>Undo Disks</em>" di Virtual Server, benedetti loro <img alt="Open-mouthed" src="http://messenger.msn.com/MMM2006-04-19_17.00/Resource/emoticons/teeth_smile.gif">, ho ripreso e portato felicemente a conclusione un task che mi ero pianificato tempo addietro. Lo scopo era:</span><br> <ul> <li>rendere accessibile il mio TFS "<em>Casalingo</em>" al mondo esterno, praticamente a casa non ci sono mai...;  </li><li>continuare ad usarlo anche dall'interno della LAN senza impazzire con le configurazioni sui client;  </li><li>accedervi senza che sia necessario utilizzare una VPN come faccio adesso (ad esempio a FastWeb le VPN non piacciono per nulla...);  </li><li>ovviamente rendere sicuro il canale con SSL;  </li><li>limitare all'osso i problemi derivanti dai filtri che alcuni provider metteno sull'autenticazione NTLM;</li></ul> <span>la primissima cosa che ho fatto è stata scrivere una mail al "<em><a href="http://blogs.ugidotnet.org/lbarbieri" target="_blank">Team Foundation Server Man</a></em>" per eccellenza e chiedergli lumi perchè avevo trovato un paio di risorse sul web che si sovrapponevano e non capivo bene quale fosse la strada giusta.</span><br> <span>Alla fine la scelta è ricaduta (grazie a Lorenzo) su questo whitepaper ufficiale Microsoft: <a title="http://msdn2.microsoft.com/en-gb/library/aa833872(VS.80).aspx" href="http://msdn2.microsoft.com/en-gb/library/aa833872(VS.80).aspx">http://msdn2.microsoft.com/en-gb/library/aa833872(VS.80).aspx</a> che spiega nel dettaglio tutti i passaggi per poter pubblicare TFS su SSL.</span><br> <span>Non mi soffermo sugli step dell'articolo che sono parecchi ma ben documentati e precisi, fate, e ripeto fate, un backup di <em>tutto il mondo</em> prima di mettere mano al tutto... <em>Developer e IT Pro avvisato... <img alt="Open-mouthed" src="http://messenger.msn.com/MMM2006-04-19_17.00/Resource/emoticons/teeth_smile.gif"> <cit.></em></span><br> <span>La configurazione dell'ISAPI Filter per IIS <strong>non</strong> è uno step obbligatorio ma lo diventa se volete avevre l'opportunità di liberarvi di NTLM per la connessione a TFS dall'eterno (<a title="http://msdn2.microsoft.com/en-gb/library/aa833874(VS.80).aspx" href="http://msdn2.microsoft.com/en-gb/library/aa833874(VS.80).aspx">http://msdn2.microsoft.com/en-gb/library/aa833874(VS.80).aspx</a>).</span><br> <span>Se la procedura va a buon fine siete ora in grado di connettervi dalla vostra LAN al TFS su SSL e potete essere felici perchè già arrivare li non è proprio da tutti <img alt="Tongue out" src="http://messenger.msn.com/MMM2006-04-19_17.00/Resource/emoticons/tongue_smile.gif">... sappiate però che a questo punto siete in un vicolo cieco:</span><br> <ul> <li>nessun supporto;  </li><li>nessuna possibilità di installare service packs a causa dei cambiamenti nella configurazione;</li></ul> <span>I problemi nella mia configurazione sono sorti quando ho affrontato ISA Server... <em>benedetto figgggghiu mio...</em></span><br> <span>Un piccolo preambolo, la mia configurazione di rete:</span><br> <ul> <li>Router HW  </li><li>ISA Server (3 Schede di rete: LAN / FW<-->Router / DMZ)  </li><li>LAN Interna  <ul> <li>DC  </li><li>TFS  </li><li>Exchange  </li><li>Etc...</li></ul> </li><li>I nomi interni non coincidono con i nomi pubblici (e questo è un problema per TFS...o meglio potrebbe esserlo)</li></ul> <span>Il problema della pubblicazione di TFS è legato in particolare ai FQDN che vengono usati per connettersi, essendo un'applicazione composta da <em>n</em> applicazioni distinte (TFS, SharePoint, ReportingServices) internamente i riferimenti agli url sono importanti e in alcuni casi (molti) includono anche il nome del server e la porta...</span><br> <span>Il problema della nomenclatura si riflette di conseguenza anche su Visual Studio, dovendo lavorare sia in LAN che da fuori quando apro Visual Studio non voglio avere problemi di nomi non risolti etc... etc... Per fare ciò vi basta mettere mano al DNS e definire delle entry (Record A o Alias) anche per i nomi pubblici facendo si che vengao risolti con l'IP interno.</span><br> <span>Fatto questo dall'interno della LAN il TFS è raggiungibile con il <strong>nome pubblico</strong> e su <strong>SSL</strong>, e abbiamo risolto almeno 2 degli obiettivi posti.</span><br> <span>Vediamo adesso di capire come pubblicare all'esterno il tutto facendolo digerire al reverse proxy di ISA Server.</span><br> <span>In un'installazione di default di TFS la configurazione è già abbastanza complessa, nella mia installazione <em>personalizzata</em> lo è un po' di più perchè ci sono due aggiunte:</span><br> <ul> <li>Windows SharePoint Services 3.0 in sostituzione ai WSS2.0: TFS adesso usa la nuova versione, ma purtroppo non posso rimuovere i 2.0 (perchè necessari per la prima installazione e usati da TFS tutt'ora) quindi vivono Side By Side;  </li><li>Team System Web Access: un portale web per accedere a tutte le funzionalità di TFS (SourceControl escluso) da internet senza aver bisogno di nessun client;</li></ul> <span>Questo comporta che la situazione IIS è più o meno questa sulla macchina di TFS (tfs.domain.local):</span><br> <ul> <li>Team System Web Access  <ul> <li>HTTP: 80 e 8090  </li><li>HTTPS: 4343</li></ul> </li><li>Team Foundation Server  <ul> <li>HTTP: 8080  </li><li>HTTPS: 4433</li></ul> </li><li>ReportServer e WSS 2.0  <ul> <li>HTTP: 80  </li><li>HTTPS: 433</li></ul> </li><li>SharePoint Central Administration v3  <ul> <li>HTTP: 32281  </li><li>HTTPS: 44333</li></ul> </li><li>SharePoint Central Administration  <ul> <li>HTTP: 17012  </li><li>HTTPS: 43333</li></ul> </li><li>SharePoint Services 3.0:  <ul> <li>HTTP: 81  </li><li>HTTPS: 4443</li></ul></li></ul> <span>perchè questo sfacelo di porte per HTTP e HTTPS? semplicemente perchè io sono un poveretto e ho un solo IP Pubblico (neanche statico per inciso) quindi per la gestione devo affidarmi ai WebListener di ISA e utilizzare le porte come discrimninante per fare il redirect sulle macchine interne... in ISA server "<em>purtroppo</em>" (non è che loconosca bene quindi magari sono io che non ho capito) non c'è mezzo di creare 2 WebListener in ascolto sulla stessa porta che usino come discriminate l'url richiesto, ad esempio sarebbe comodo poter dire a ISA:</span><br> <span>Se la richiesta che ti arriva è per <a href="http://www.mydomain.tld">www.mydomain.tld</a> allora fammi il redirect su myinternalwebserver.domain.local:80 mentre se la richiesta è per pippo.mydomain.tld allora vai da un'altra parte... putrooppo è necessario specificare anche una porta su cui è in ascolto il listerner quindi quello che potete fare è se la richiesta è per <a href="http://www.mydomain.tld">www.mydomain.tld</a> (sottointeso :80) allora fai il redirect su una certa macchina, se invece è per pippo.mydomain.tld:8080 fai il redirect su un'altra macchina.</span><br> <span>A questo punto armatevi di santa pazienza e create i vari listener e le regole di pubblicazione facendo attenzione a:</span><br> <ul> <li>ogni Listener (uno per funzionalità che vogliamo pubblicare) ascolta solo sulla porta SSL;  </li><li>Ogni listener non ha nessuna configurazione relativa all'utenticazione, tutto è delegato a IIS sulla macchina TFS;  </li><li>nelle publishing rule di ogni sito, nella tab "Bridge", definite il redirect non verso la porta SSL ma bensì verso quella HTTP:<br><br><a href="http://blogs.ugidotnet.org/images/blogs_ugidotnet_org/topics/WindowsLiveWriter/TFS.eXTeamFoundationServerSSLeilReverseP_FE5E/bridging.jpg" atomicselection="true"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="110" alt="bridging" src="http://blogs.ugidotnet.org/images/blogs_ugidotnet_org/topics/WindowsLiveWriter/TFS.eXTeamFoundationServerSSLeilReverseP_FE5E/bridging_thumb.jpg" width="240" border="0"></a> <br> </li><li>nella tab "To" della publishing rule eseguite il redirect verso il <strong>nome interno</strong> del sito specificando l'indirizzo IP della macchina:<br><br><a href="http://blogs.ugidotnet.org/images/blogs_ugidotnet_org/topics/WindowsLiveWriter/TFS.eXTeamFoundationServerSSLeilReverseP_FE5E/to.jpg" atomicselection="true"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="202" alt="to" src="http://blogs.ugidotnet.org/images/blogs_ugidotnet_org/topics/WindowsLiveWriter/TFS.eXTeamFoundationServerSSLeilReverseP_FE5E/to_thumb.jpg" width="240" border="0"></a> <br> </li><li>abilitate la casella di spunta "Forward the original Host Header..." e fate in modo che la richiesta provenga dal client originale (Request apper to come from the original client) e non da ISA: pena un bel "TFXXXX...<em>access denied user does not have access to tfs...</em>" da parte di TFS quando vi connettete con Visual Studio</li></ul> <span>Le ultime 3 note sono fondamentali: la tecnica classica per pubblicare un Web Server attraverso ISA Server è quella di avere un nome esterno diverso dal nome interno del server da pubblicare, in questo modo è possibile, ad esempio, pubblicare il Web Server su SSL e fare anche la connessione da ISA verso il Web Server sempre su SSL, questo perchè se i nomi coincidono ISA si arrabbia ritornando un bel (e un po' misterioso...) HTTP500 Server Internal Error (Incorrect Server Principal Name), nel nostro caso non possiamo fare così perchè abbiamo bisogno che il nome esterno e il nome interno siano identici pena difficoltà/impossibilità di connettersi dall'interno. Facendo si invece che la richiesta da ISA vada verso la parte non SSL non abbiamo nessun problema di certificati digitali all'interno della LAN nella comunicazione tra ISA e TFS.</span><br> <span>Fatti questi passaggi ricodatevi, dopo aver fatto qualche test di connettività con un browser, di installare il certificato della CA sul client se, come nel mio caso, la CA che emette il certificato non è trusted (nel mio caso la CA sono io stesso...quindi mi trasto da solo) questo è fondamentale perchè mentre il browser vi da un warning e vi consente di dedicedere se continuare o meno con la connessione, VS invece fallisce a priori e vi ritorna un bell'errore e basta.</span><br> <span>Una nota importante:<br><strong>non mi assumo nesuna responsabilità per i danni immani che potreste fare al vostro TFS seguendo la stessa procedura, se lo fate e vi si schianta tutto non venite a piangere da me</strong>... <img alt="Wink" src="http://messenger.msn.com/MMM2006-04-19_17.00/Resource/emoticons/wink_smile.gif"></span><br> <span>se avete domande invece fatevi sotto!</span><br> <span>.m</span><br>
---
layout: post
title: ClickOnce & Environment
date: '2009-01-22T09:02:00.000+01:00'
author: Mauro Servienti
tags:
- Software Mason
modified_time: '2012-01-31T14:02:15.334+01:00'
thumbnail: https://lh3.googleusercontent.com/-jXCx-RJLjYI/TyfmUR2S10I/AAAAAAAAATY/870Y2ZUNHzE/s72-c/image_thumb.png
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-7468461509215992446
blogger_orig_url: http://milestone.topics.it/2009/01/clickonce-environment.html
permalink: /2009/01/clickonce-environment.html
---

<span>ClickOnce, per certe cose, è una tecnologia fantastica, se però siete in un ambiente un po’ complesso e avete i classici ambienti di Sviluppo, Test, Produzione e chi più ne ha più ne metta scoprite che Visual Studio non digerisce questa cosa neanche a spingere…</span><br>  <span>Ci sono un po’ di soluzioni con pregi e difetti, partiamo da Visual Studio e poi vediamo come affronta la cosa ClickOnce. La situazione classica è la necessità di avere file di configurazione diversi per ambiente diverso, classicamente ad esempio cambia la connection string al db, quello che possiamo fare è:</span><br>  <span><a href="https://lh3.googleusercontent.com/-A9n0eIN_tGg/TyfmU2xU_sI/AAAAAAAAATc/EsrEnbf21DQ/image_2.png" rel="lightbox"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="https://lh3.googleusercontent.com/-jXCx-RJLjYI/TyfmUR2S10I/AAAAAAAAATY/870Y2ZUNHzE/image_thumb.png" width="211" height="166"></a> </span><br>  <span>nella solution creiamo una struttura di cartelle in cui inserire i vari file di configurazione, ogni cartella dentro “Copnfig Files” ha lo stesso nome di una configurazione della solution, c’è poi direttamente un file app.config dentro “Config Files” che serve da fallback nel caso in cui non esista un file specifico per una configurazione.</span><br>  <span>A questo punto possiamo scegliere una configurazione per la nostra solution:</span><br>  <span><a href="https://lh4.googleusercontent.com/-QCEv1FcGEiw/TyfmVgsWT4I/AAAAAAAAATs/-UA0JMkhVoM/image_4.png" rel="lightbox"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="https://lh6.googleusercontent.com/-TbZJjFlk67E/TyfmVFQmnNI/AAAAAAAAATk/2y1Awg4_AQM/image_thumb_1.png" width="244" height="29"></a> </span><br>  <span>e provare a compilare, naturalmente non succede un bel nulla :-D… speravate fosse così facile. In realtà non è poi molto difficile, andiamo nelle proprietà del progetto e nei Post Build Event mettiamo qualcosa del tipo:</span><br>  <blockquote>   <span>if exist "$(ProjectDir)Properties\Config Files\$(ConfigurationName)\app.config" (      <br>    copy "$(ProjectDir)Properties\Config Files\$(ConfigurationName)\app.config" "$(ProjectDir)$(OutDir)$(TargetName).config" /Y       <br>) else (       <br>    copy "$(ProjectDir)Properties\Config Files\app.config" "$(ProjectDir)$(OutDir)$(TargetName).config" /Y       <br>)</span><br> </blockquote>  <span>che altro non fa che controllare se un file per una data configurazione esiste altrimenti usa il file di fallback. La cosa è abbastanza semplice e non è certo una novità, ci sono molti post che ne parlano.</span><br>  <span>Veniamo adesso a ClickOnce… “il simpaticone” non digerisce molto questa cosa, o meglio non si lamenta ma non funziona perchè “il simpaticone” non prende il file di configurazione che trova nella directory di output del progetto ma bensì quello che sta nella root del progetto di Visual Studio…ma si facesse gli affari suoi…</span><br>  <span>Una <a href="http://blog.gatosoft.com/PermaLink,guid,d0a0dd1e-c9ac-4fa9-a408-615454d49702.aspx" target="_blank">soluzione</a> c’è, è molto bella, fa un sacco di belle cose ma un po’ troppo complessa da gestire, inoltre è pensata per Visual Studio 2005 e lo schema del deploy di ClickOnce di Visual Studio 2008 SP1 è un po’ diverso e quindi va adattata a suon di “prova e sbaglia” perchè c’è poca se non nulla documentazione, ci apre anche alla magagna di dover star dietro alle evoluzioni future dello schema.</span><br>  <span>Ma… si può fare <cit.> ed è abbastanza banale, prendiamo il nostro post build event e lo modifichiamo così:</span><br>  <blockquote>   <span>if exist "$(ProjectDir)Properties\Config Files\$(ConfigurationName)\app.config" (      <br>    copy "$(ProjectDir)Properties\Config Files\$(ConfigurationName)\app.config" "$(ProjectDir)app.config" /Y       <br>) else (       <br>    copy "$(ProjectDir)Properties\Config Files\app.config" "$(ProjectDir)app.config" /Y       <br>)</span><br> </blockquote>  <span>con l’accortezza di spostarlo dai Post Build Event ai Pre Build Event, quello che succede è che il file di configurazione che sta nella root del progetto viene sostituito prima della compilazione con 2 effetti:</span><br>  <ul>   <li>nella directory di output del progetto ci troviamo il file che ci aspettiamo, per l’ambiente giusto;</li>    <li>cambiando direttamente il file config del progetto “il simpaticone” (aka ClickOnce) prende il file giusto;</li> </ul>  <span>Unica accortezza, se usate un sistema di source control, è quella di escludere dal source control il file app.config nella root dell’applicazione in modo da evitare fallimenti della build per il semplice fatto che il file sia in checkin.</span><br>  <span>C’è anche un’altra soluzione: costruire un task di MS Build… ma il gioco non vale la candela.</span><br>  <span>.m</span><br>

---
layout: post
title: 'RavenDB: index management options'
date: '2012-12-04T13:52:00.000+01:00'
author: Mauro Servienti
tags:
- Software Mason
- RavenDB
modified_time: '2012-12-04T13:52:00.389+01:00'
thumbnail: http://lh6.ggpht.com/-v2ZDdqL1DAk/UKCfLDDZVWI/AAAAAAAACYQ/q3aTbGmB4CU/s72-c/image_thumb1.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-3578712862524279258
blogger_orig_url: http://milestone.topics.it/2012/12/ravendb-index-management-options.html
permalink: /2012/12/ravendb-index-management-options.html
---

<p>We have <a href="{{ site.baseurl }}{% post_url 2012-11-26-ravendb-map-index %}" target="_blank">recently introduced the basic concepts</a> about indexing in <a href="http://ravendb.net" target="_blank">RavenDB</a>. We left without saying nothing about the options we, as developers, have to manage indexes:</p> <ul> <li>Manually via the RavenDB Studio;  <li>Programmatically directly within the application;</li></ul> <p><strong>Index overview</strong></p> <p>If we take a look at the Indexes tab in the Studio and we edit one of the indexes we can see something that we, as .net developers, are really familiar with: linq.</p> <p><a href="http://lh6.ggpht.com/-a75kDxa6oGw/UKCfI4FyOcI/AAAAAAAACYI/_oTTTy2eJQo/s1600-h/image3.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://lh6.ggpht.com/-v2ZDdqL1DAk/UKCfLDDZVWI/AAAAAAAACYQ/q3aTbGmB4CU/image_thumb1.png?imgmax=800" width="335" height="123"></a></p> <p>An index is defined using a linq expression, wow, but as we may suspect the server has no knowledge at all of what a linq expression is, what we see in the index editor is basically text, familiar to us, but text that the server can understand and use to “run” the index.</p> <p><strong>Manual index management</strong></p> <p>So…as we can imagine we can use the Studio to create and manage indexes, creating a new index is just a matter of defining the correct lambda expression that defines what we want to index, basically nothing more.</p> <p>As we can imagine as the index complexity grows the manual management can become cumbersome.</p> <p><strong>Programmatic index management</strong></p> <p>The following map/reduce index is a good starting point:</p> <p><a href="http://lh3.ggpht.com/-FvCjqnGakUQ/UKCfM9cHEVI/AAAAAAAACYY/6G4WWr28Ak8/s1600-h/image%25255B4%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://lh3.ggpht.com/-eVFlYbKcl-U/UKCfOab1-JI/AAAAAAAACYg/X-vHsPCnv-w/image_thumb%25255B1%25255D.png?imgmax=800" width="341" height="201"></a></p> <p>it is still a fairly simple index (a sort of tag cloud) but is a good sample of the manual management complexity we can achieve quickly. The above index can be fully managed by code:</p> <blockquote> <div id="codeSnippetWrapper"><pre id="codeSnippet" style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> Genres_Count : AbstractIndexCreationTask&lt;Album, Genres_Count.GenresCloud&gt;<br>{<br>    <span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> GenresCloud<br>    {<br>        <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Id { get; set; }<br>        <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Name { get; set; }<br>        <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> Count { get; set; }<br>    }<br><br>    <span style="color: #0000ff">public</span> Genres_Count()<br>    {<br>        <span style="color: #0000ff">this</span>.Map = albums =&gt; from album <span style="color: #0000ff">in</span> albums<br>                        select <span style="color: #0000ff">new</span><br>                        {<br>                            Id = album.Genre.Id,<br>                            Name = album.Genre.Name,<br>                            Count = 1<br>                        };<br><br>        <span style="color: #0000ff">this</span>.Reduce = results =&gt; from genreCount <span style="color: #0000ff">in</span> results<br>                            group genreCount by genreCount.Id into g<br>                            select <span style="color: #0000ff">new</span><br>                            {<br>                                Id = g.Key,<br>                                Name = g.First().Name,<br>                                Count = g.Sum( x =&gt; x.Count )<br>                            };<br><br>        <span style="color: #0000ff">this</span>.IndexSortOptions.Add( i =&gt; i.Count, Raven.Abstractions.Indexing.SortOptions.Int );<br>    }<br>}</pre><br></div></blockquote>
<p>The above C# code is exactly equal to the index we have seen in the studio, in fact the index in the studio has been generated at application startup time using the following one line of code:</p>
<blockquote>
<div id="codeSnippetWrapper"><pre id="codeSnippet" style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4"><span style="color: #008000">//ds is an instance of IDocumentStore</span><br>IndexCreation.CreateIndexes( Assembly.GetExecutingAssembly(), ds );</pre><br></div></blockquote>
<p>We have defined in a single class, inheriting from the RavenDB AbstractIndexCreationTask&lt;TDocument, TReduceResult&gt;:</p>
<ol>
<li>the name of the index, the convention is that My_Sample_Index is translated by the server into a index named My/Sample/Index;</li>
<li>The map logic;</li>
<li>The reduce logic;</li>
<li>Some index options;</li>
<li>And the shape of the reduce result;</li></ol>
<p>Having a strongly typed index definition allows us to write some strongly typed C# code to use it:</p>
<blockquote>
<div id="codeSnippetWrapper"><pre id="codeSnippet" style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4">var cloud = await Task.Factory.StartNew&lt;IEnumerable&lt;Genres_Count.GenresCloud&gt;&gt;( () =&gt;<br>{<br>    <span style="color: #0000ff">using</span>( var session = <span style="color: #0000ff">this</span>.documentStore.OpenSession() )<br>    {<br>        var data = session.Query&lt;Genres_Count.GenresCloud, Genres_Count&gt;()<br>            .OrderByDescending( c =&gt; c.Count );<br><br>        <span style="color: #0000ff">return</span> data;<br>    }<br>} );</pre><br></div></blockquote>
<p>.m</p>  

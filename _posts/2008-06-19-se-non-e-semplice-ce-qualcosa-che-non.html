---
layout: post
title: Se non è semplice c’è qualcosa che non va…
date: '2008-06-19T05:03:00.000+02:00'
author: Mauro Servienti
tags:
- Why not...
modified_time: '2012-01-29T11:02:16.792+01:00'
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-4189388449260068429
blogger_orig_url: http://milestone.topics.it/2008/06/se-non-e-semplice-ce-qualcosa-che-non.html
permalink: /2008/06/se-non-e-semplice-ce-qualcosa-che-non.html
---

<span>Questo è un periodo veramente intenso che ha però il grandissimo pregio di permettermi di imparare moltissimo e di fare esperienze veramente interessanti.</span><br>  <span>Nei giorni scorsi stavo leggendo un po’ di “<em>arretrati</em>” e sfogliano un <a href="http://ayende.com/Blog/archive/2008/06/13/New-project-blues.aspx" target="_blank">post di Ayende</a> leggo il <a href="http://ayende.com/Blog/archive/2008/06/13/New-project-blues.aspx#23612" target="_blank">commento di Tommaso Caldarola</a> e devo dire che, nonostante Ayende sia di parere contrario, io mi trovo in piena sintonia con quello che dice Tommaso.</span><br>  <span>Possiamo estendere e parafrasare quello che dice Tommaso (sperando di non prendere fischi per fiaschi) dicendo che:</span><br>  <blockquote>   <span>“<em>se un “framework” o per meglio dire la sua interfaccia pubblica, non sono di semplice ed intuitivo utilizzo probabilmente c’è qualche problema quantomeno di design se non addirittura architetturale.</em>”</span><br> </blockquote>  <span>Quando mi approccio ad un nuovo problema quello che faccio è partire quasi sempre da un livello molto alto: l’utente finale. Mi metto cioè il cappellino dell’utente finale e scrivo le <a href="http://en.wikipedia.org/wiki/User_story" target="_blank">User Story</a>. Come ho già avuto modo di dire quello è il nostro requisito vero e proprio se non soddisfiamo il nostro utente finale direi che abbiamo fallito.</span><br>  <span>Questo approccio mi permette <em>quasi</em> sempre di creare/modellare un insieme di servizi e componenti che dal macro problema portano alla risoluzione della singola operazione unitaria senza che però sia noto all’utilizzatore cosa succede dietro le quinte.</span><br>  <blockquote>   <span>UserRepositoryProcess urp = new UserRepositoryProcess( <em>currentSecurityContext</em> );       <br>IEntityCollection<IUser> allUsers = urp.GetAll();</span><br> </blockquote>  <span>Dietro queste due semplicissime righe di codice succedono una quantità industriale di cose ma l’utente (in questo caso il developer) non è tenuto a saperle, e questo non tanto per “segretezza” ma semplicemente perchè non c’è nessuna necessità di portare complessità la dove non serve.</span><br>  <span>Perchè sto dicendo tutto ciò? per il semplice fatto che in questi giorni mi sto scontrando con qualcosa che non riesco a rendere semplice… e quindi è prono a continui errori e rivisitazioni proprio perchè non è intuitivo.</span><br>  <span>Vediamo da cosa nasce il problema e se vi va intavoliamo una discussione (che nel caso sposterei sul forum):</span><br>  <blockquote>   <span>public interface IUnitOfWork : IDisposable      <br>{       <br>    void RegisterDeleted(object item);       <br>    void RegisterDirty(object item);       <br>    void RegisterNew(object item);       <br></span><br>    <span>    void Commit();      <br>    void Rollback();       <br>}</span><br> </blockquote>                                    <span>Queslla esposta è, una parte, dell’interfaccia pubblica della UnitOfWork di <a href="http://download.manageddesigns.it/nsk.aspx" target="_blank">NSK</a>.</span><br>  <span>Vista così, voi direte…, ma che c’è che non va? in realtà nulla, ma se la caliamo in un’applicazione decisamente complessa direi che potremmo obiettare che:</span><br>  <ul>   <li>Non è un servizio, quindi non è esponibile come tale, per il semplice fatto che ha bisogno di mantenere lo stato; </li>    <li>se ci caliamo in una realtà complessa lo strato di UnitoOfWork è decisamente lontano dall’utilizzatore e ritengo che ci debbano essere almeno un paio di strati tra l’utilizzatore e l’ingresso sulla scena della UoW. Ergo ho la sensazione che abbia più responsabilità di quelle che dovrebbe avere. </li> </ul>  <span>Il primo punto direi che non necessita spiegazioni: se faccio <em>n</em> chiamate ai vari <em>Register*</em> prima di arrivare ad una Commit o ad una Rollback devo mentenere la lista delle operazioni da eseguire internamente alla UoW.</span><br>  <span>Il secondo punto invece necessità di qualche approfondimento, la realtà in cui vorrei che vi calaste è la seguente:</span><br>  <ul>   <li>Siete in una applicazione web, <a href="http://groups.google.it/group/microsoft.public.it.dotnet.asp/browse_thread/thread/3bf620e9d408a73b/62b83c722a4aa710?hl=it&lnk=st&q=%22Mauro+Servienti%22+conversazione#62b83c722a4aa710" target="_blank">con tutto quello che ne consegue...</a>; </li>    <li>avete bisogno di offrire un contesto transazionale anche in memoria: <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.irevertiblechangetracking.aspx" target="_blank">IRevertibleChangeTracking</a>/similari…; </li>    <li>Siete in una situazione in cui il ciclo di vita di un grafo di entity “spanna” più richieste http: <em>Conversazione</em>; </li>    <li>Gestite un grafo di oggetti abbstanza complesso e non siete limitati alla manipolazione di una entity alla volta: per capirci dovete permettere all’utente di:      <ul>       <li>aprire un <em>ICustomer</em>; </li>        <li>modificare il CustomerName; </li>        <li>aggiungere un <em>IAddress</em>; </li>        <li>rimuovere un <em>IAddress</em> esistente; </li>        <li>creare un nuovo <em>IOrder</em> per il customer aperto; </li>        <li>inserire un po’ di righe/prodotti nell’ordine, di cui magari alcuni prodotti non esistono e quindi vanno creati al volo… </li>        <li>e… permettere all’utente di fare un “Undo” progressivo delle modifiche che ha apportato al “grafo/mondo” che sta manipolando…; </li>        <li>alla fine persistere tutto il lavoro <u>effettivamente</u> (quindi al netto degli <em>Undo</em>) fatto; </li>     </ul>   </li> </ul>                                                                                              <span>Se non ho interpretato male in NSK la UnitOfWork è la “sessione” quindi ho una o più UoW per “utente”, quello che mi manca è la possibilità di fare rollback di una singola attività fatta. E’ in questa direzione che vedo la UnitOfWork come un qualcosa che sta ad un livello basso e che viene utilizzato ad un livello troppo alto.</span><br>  <span>Quello che succede (o meglio che “dovrebbe”) nell’applicazione che stiamo sviluppando è quindi:</span><br>  <ul>   <li>Inizio della conversazione; </li>    <li>Inserimento dei dati che stiamo manipolando nella conversazione; </li>    <li>manipolazione del dato che a questo punto può “spannare” su più richieste http; </li>    <li>recupero del set (ChangeSet) delle modifiche che sono state apportate ai dati in conversazione; </li>    <li>passaggio del ChangeSet alla UnitOfWork; </li> </ul>  <span>Dietro le quinte la UoW dato il ChangeSet è in grado di:</span><br>  <ul>   <li>“estrarre” le sole entity che hanno bisogno di persistere modifiche; </li>    <li>per quelle entity capire quale sia l’effettiva operazione (C..UD) da eseguire; </li>    <li>recuperare il “Persistence Service” adeguato; </li>    <li>Aprire una transazione e fare il commit in maniera transazionale; </li> </ul>  <span>Internamente ogni persistence service:</span><br>  <ul>   <li>recupra l’adapter corretto per la entity che ha in mano e per l’operazione che deve eseguire; </li>    <li>invoca l’esecuzione; </li> </ul>  <span>E a questo punto se non ci sono stati problemi:</span><br>  <ul>   <li>conclusione della conversazione; </li> </ul>  <span>Detto questo siamo in grado di fare diventare la UoW un servizio che non mantiene stato e che effettivamente fa il lavoro per cui è stato pensato.</span><br>                                                                                    <span>…mumble, mumble… </span><br>  <span><img alt="" src="http://blogs.ugidotnet.com/images/blogs_ugidotnet_org/markino/624/o_Thinking.jpg"></span><br>  <span>Oggi mi sento un po’ <a href="http://blogs.ugidotnet.org/Markino" target="_blank">M.rkino</a> pensieroso :-D</span><br>  <span>.m</span><br>

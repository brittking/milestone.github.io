---
layout: post
title: 'Conversazione: “non solo overview” <semi-cit.>'
date: '2009-08-25T18:56:00.000+02:00'
author: Mauro Servienti
tags:
- Software Mason
modified_time: '2012-02-02T12:17:51.075+01:00'
thumbnail: https://lh5.googleusercontent.com/-PUB7dJ4aorE/TypwyDxSnRI/AAAAAAAAAmw/5-tQ9ygPD8U/s72-c/image_thumb.png
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-5001943265322451544
blogger_orig_url: http://milestone.topics.it/2009/08/conversazione-non-solo-overview.html
---

<span>una piacevole chiaccherata via messenger con <a href="http://cradle.aspitalia.com/" target="_blank">Marco di Sanctis</a> mi porta verso questo post che probabilmente sarà il primo di una serie, probabilmente.</span><br>  <span>Vediamo di dare un paio di definizioni giusto per inquadrare lo scenario:</span><br>  <span><em>Database Transaction</em>: è una transazione <u>specificamente</u> sui dati il cui scope è limitato al database/storage, per sua natura deve essere il più “stretta” possibile, dove per stretta intendiamo iniziare il più tardi possibile e terminare il prima possibile; il perchè è evidente: durante una transazione a livello di storage abbiamo, in base al livello di isolamento, fondamentalmente un lock pessimistico sui dati ergo gli altri sono accodati in attesa che la nostra transazione finisca. Probabilmente è una visione molto semplicistica della situazione ma direi che rende bene l’idea.</span><br>  <span><em>Business Transaction</em>: il mondo purtroppo non è più semplice come una volta e quindi astraendoci dallo storage abbiamo un concetto di transazione un po’ più ampio: abbiamo infatti il concetto di “transazione utente”, un esempio su tutti potrebbe essere la creazione di un preventivo che comporta probabilmente <em>n</em> transazioni con il database ed ha un ciclo di vita decisamente più ampio.</span><br>  <span>Schematizzando potremmo quindi dire che lo scenario più semplice è il seguente:</span><br>  <span><a href="https://lh4.googleusercontent.com/-ov2sMnKzYpI/TypwygM7AOI/AAAAAAAAAm0/5Xdpls4_CjQ/image_2.png" rel="lightbox"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Sample" border="0" alt="Sample" src="https://lh5.googleusercontent.com/-PUB7dJ4aorE/TypwyDxSnRI/AAAAAAAAAmw/5-tQ9ygPD8U/image_thumb.png" width="244" height="78"></a> </span><br>  <span>In cui la transazione di business coincide con la transazione sui dati, ma se ci ragioniamo su un po’ scopriamo che praticamente è inapplicabile ad uno scenario reale, vediamo quindi la situazione prima di andare avanti:</span><br>  <span>Avete la vostra bella <u>applicazione desktop</u>, quindi un rich-client, che ha la velleità di gestire questo semplicissimo dominio:</span><br>  <span><a href="https://lh4.googleusercontent.com/-KE_Lvd5NfF8/Typwz87W-oI/AAAAAAAAAnI/LuFW5_SCjk4/image_4.png" rel="lightbox"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Domain" border="0" alt="Domain" src="https://lh5.googleusercontent.com/--nakPf8VP5U/TypwzFUWT4I/AAAAAAAAAnA/nbSa8RGaeF0/image_thumb_1.png" width="244" height="220"></a> </span><br>  <span>Ho collassato una parte di proprietà e metodi solo per leggibilità, per ora i tecnicismi sono del tutto irrilevanti. Detto questo vediamo alcune delle<em> User Story</em> che dobbiamo realizzare:</span><br>  <blockquote>   <span><strong>Creazione Anagrafica</strong>       <br>Come utente voglio poter creare un nuovo soggetto al fine di gestire le anagrafiche dei mie clienti.</span><br>    <span><strong>Modifica Anagrafica Esistente</strong>       <br>Come utente voglio poter modificare l’anagrafica di un soggetto creato in precedenza al fine di tener aggiornati i dati.</span><br> </blockquote>  <span>Per ora fermiamoci qui e introduciamo qualche <em>amato</em> tecnicismo, essendo un’applicazione desktop è lecito aspettarsi (e questo è quello che si aspetta il mio utente) che le 2 operazioni sopra citate possano essere fatte in contemporanea e a loro volta contemoraneamente più volte, quindi posso ad esempio editare 4 anagrafiche diverse contemporaneamente ognuna nel suo “screen”, dove per screen potremmo intendere una form di editing o un documento in un modello mdi o quello che più vi piace restando il fatto che di questi screen ce ne possono essere <em>n</em> in contemporanea, esattamente come quando con Outlook aprite per l’editing 4 contatti insieme.</span><br>  <span>Le operazioni (operazioni utente) contemporanee avranno quindi la necessità di avere transazioni di business separate in modo che il commit di una transazione non influenzi lo stato dell’altra. Nelle User Story di cui sopra la cosa è ancora abbastanza semplice, diciamo che quello che succede è più o meno “sintetizzabile” così:</span><br>  <ol>   <li>     <div align="left">L’utente clicca il bottone “<strong>nuovo soggetto</strong>”;</div>   </li>    <li>     <div align="left">La UI fa il <a href="http://blogs.ugidotnet.org/topics/archive/0001/01/01/imessagebroker.aspx" target="_blank">dispacth di un messaggio</a> con la richiesta in oggetto;</div>   </li>    <li>     <div align="left"><a href="http://blogs.ugidotnet.org/topics/archive/0001/01/01/ui-composition-imessagebroker-castle-windsor-e-le-facility.aspx" target="_blank">Qualcuno</a> reagisce, <em>Separation of Concern</em>, e:</div>   </li> </ol>  <ol>   <ol>     <li>       <div align="left">Crea una UnitOfWork;</div>     </li>      <li>       <div align="left">Crea un’istanza della nuova entity;</div>     </li>      <li>       <div align="left"><em>Sparapacchia</em> a sua volta un messaggio con la richiesta di edit di una entity, allegato al messaggio ci mette:</div>        <ul>         <li>           <div align="left">La entity da editare;</div>         </li>          <li>           <div align="left">Una callback perchè vuole essere informato quando l’edit è finito e vuole pure sapere l’esito, in realtà la callback è un filino più complessa perchè esiste il concetto di salvataggio in itiniere… ma è un’altra storia => OT;</div>         </li>          <li>           <div align="left">La UoW corrente;</div>         </li>       </ul>     </li>   </ol>    <li>     <div align="left">Un Editor reagisce alla richiesta e si “apre” uno screen…</div>   </li>    <li>     <div align="left">…l’utente fa quello che deve fare, tra cui i suoi comodi, e ad un certo punto pigia il pulsantino “Salva”;</div>   </li>    <li>     <div align="left">L’Editor non è responsabile del salvataggio, lui è un editor:</div>      <ol>       <li>si limita ad invocare la callback dicendo che l’utente vuole il salvataggio; </li>     </ol>   </li>    <li>Quando la callback viene invocata il chiamante:      <ol>       <li>Apre la transazione con il db; </li>        <li>salva la entity; </li>        <li>fa il Commit della transazione; </li>        <li>Butta la UoW che in questo caso non serve più a nessuno; </li>     </ol>   </li>    <li>L’editor si chiude; </li> </ol>  <span>L’altro scenario è un po’ più complesso… forse :-):</span><br>  <ol>   <li>     <div align="left">l’utente esegue una ricerca e visualizza una bella lista di risultati che fondamentalmente sono <em>projection</em> sui dati, una sorta di SearchResult<Subject>, quindi non il soggetto vero e proprio, sceglie quello che vuole editare;</div>   </li>    <li>     <div align="left">fa doppio click sull’elemento incriminato;</div>   </li>    <li>     <div align="left">La UI fa il <a href="http://blogs.ugidotnet.org/topics/archive/0001/01/01/imessagebroker.aspx" target="_blank">dispacth di un messaggio</a> con la richiesta in oggetto;</div>   </li>    <li>     <div align="left"><a href="http://blogs.ugidotnet.org/topics/archive/0001/01/01/ui-composition-imessagebroker-castle-windsor-e-le-facility.aspx" target="_blank">Qualcuno</a> reagisce, <em>Separation of Concern</em>, e:</div>      <ol>       <li>         <div align="left">Crea una UoW;</div>       </li>        <li>         <div align="left">carica in memoria la entity da editare facendo un fetch attraverso la UoW;</div>       </li>        <li>         <div align="left">…e poi è tutto uguale a prima :-)</div>       </li>     </ol>   </li> </ol>  <span><strong>Separation Of Concern</strong></span><br>  <span>Un editor è un editor e fa il suo lavoro di editare qualcosa, fondamentalmente a lui non interessa quel qualcosa da dove arriva si limita ad editarlo e ad esempio a dialogare con i componenti per la validazione. Il chiamante, e qui è importante notare che non ho specificato chi sia il chiamante perchè può essere chiunque come ad esempio un altro editor… :-), fornisce all’editor i dati da editare e la transazione di business con cui lavorare, vedremo poi perchè ci potrebbe servire (anche se è facile da immaginare).</span><br>  <span><strong>Conversazione</strong></span><br>  <span>Purtroppo non è tutto così facile, anche se già così di carne al fuoco ce ne è parecchia. Complichiamo le cose: il dominio di cui sopra è un classico esempio di master-detail (un Subject e tanti Address) rimettiamo quindi per un attimo il cappellino dell’utente e immaginiamo la scena:</span><br>  <blockquote>   <span>Come utente eseguo uno ricerca, scelgo un’anagrafica da editare, e avvio lo screen di edit, all’interno dello screen di edit ho anche la lista degli indirizzi scelgo uno degli indirizzi e apro lo screen per la modifica dell’indirizzo, al temine della modifica premo “ok” e infine premo salva nello screen di edit dell’anagrafica.</span><br> </blockquote>  <span>o peggio:</span><br>  <blockquote>   <span>Come utente eseguo uno ricerca, scelgo un’anagrafica da editare, e avvio lo screen di edit, all’interno dello screen di edit ho anche la lista degli indirizzi scelgo uno degli indirizzi e apro lo screen per la modifica dell’indirizzo, al temine della modifica premo “ok” alla fine chiudo lo screen di edit dell’anagrafica senza salvare, naturalmente mi aspetto che neanche le modifiche all’indirizzo vengano salvate.</span><br> </blockquote>  <span>Se ci pensate gli scenari possibili sono innumerevoli e anche decisamente più complessi dei 2 esposti ma se facciamo le cose per bene e se teniamo ben in mente il concetto di <a href="http://en.wikipedia.org/wiki/Separation_of_concerns" target="_blank">Separation of Concern</a> (per gli amici “<a href="http://blogs.ugidotnet.org/topics/archive/0001/01/01/piccola-divagazionehellip-ldquopersonalerdquo.aspx" target="_blank">molto tanti e molto piccoli</a>”) granularizzando i nostri componenti scopriamo che tutto è riconducibile al percorso logico di prima: abbiamo degli “inner” step fondamentalmente identici a quelli dell’editing dell’anagrafica e avendo applicato SoC allo screen di edit non abbiamo problemi a passare da una UoW a qualcosa di più complesso che possiamo finalmente definire Conversazione. Una conversazione è quindi una sorta di <em>long-running-business-transaction</em>.</span><br>  <span>Possiamo quindi sintetizzare quello che abbiamo detto e/o immaginato così:</span><br>  <span><a href="https://lh6.googleusercontent.com/-rDQvBKBC3KQ/Typw1Ezju4I/AAAAAAAAAnU/KXUn68TkmdA/image_6.png" rel="lightbox"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="https://lh3.googleusercontent.com/-1OAb-j5g12U/Typw0kqyBaI/AAAAAAAAAnM/vpdSRVxMcx8/image_thumb_2.png" width="244" height="180"></a> </span><br>  <span>Come si vede abbiamo una Conversazione “A” che è quella che sta gestendo l’editing dell’anagrafica dalla quale potrebbe nascere una seconda Conversazione “B”, che gestisce la creazione di un ordine per quell’anagrafica, che deve essere separata dalla precedente. Però purtroppo…</span><br>  <span><strong>Evil is in the details</strong></span><br>  <span>Osservate questo screenshot:</span><br>  <span><a href="https://lh5.googleusercontent.com/-pVDFmdDg0Ek/Typw2aRR1II/AAAAAAAAAnk/6OZLEnpdsS8/image_8.png" rel="lightbox"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="https://lh4.googleusercontent.com/-PgoYRiJc1iA/Typw1pp_jeI/AAAAAAAAAnc/Yll4IZvf5Cg/image_thumb_3.png" width="244" height="166"></a></span><br>  <span>notate che il subject del draft in edit è stato modificato ma giustamente, non essendo ancora stato salvato l’item nella ListView di Outlook ha ancora il subject vecchio?</span><br>  <span>Tutto quello che abbiamo detto fino ad ora non tiene minimamente conto dei dettagli implementativi che è vero che sono dettagli ma rischiano di mandare tutto alle cozze… quindi okkio ai dettagli ;-) dettagli che poi sono quelli che mancano dalla stragrande maggioranza dei post sull’argomento, cosa che in generale mi fa abbastanza incazzare perchè è facile fare l’architetto figo che sentenzia a destra e a sinistra dimenticandosi che poi le cose devono essere implementate e usate dall’utente finale e non restare delle belle cose sulla carta… sfogo :-)</span><br>  <span><strong>Presentation perchè sei tu Presentation</strong></span><br>  <span>quando c’erano i terminali a caratteri era tutto più facile :-) fino ad ora abbiamo sempre e solo parlato di entità del dominio, sono quelle che giustamente ci portiamo in giro tra gli editor ma se pensiamo di “appiccicare” un editor vero e proprio sopra il nostro modello ci scordiamo quello che vediamo, ed è la cosa giusta, in Outlook.</span><br>  <blockquote>   <span>Il problema è molto semplice: <u>Reference Type</u>.</span><br> </blockquote>  <span>Marco giustamente diceva: passa all’editor un “id” e lascia che sia lui a fare il resto, in effetti la cosa non fa una grinza ma durante i mie 13km a piedi per andare in palestra ci ho rimuginato a lungo e alla fine non può funzionare: vediamo il caso più semplice in cui fallirebbe (ne ho trovati almeno altri 3):</span><br>  <ol>   <li>Avvio dell’edit passando la PK; </li>    <li>L’editor apre la UoW e carica il dato; </li>    <li>L’utente vuole editare uno degli indirizzi; </li>    <li>Avvio dell’editor:      <ol>       <li>passaggio della pk da editare; </li>        <li>passaggio della UoW perchè l’editing dell’indirizzo è nella nostra conversazione; </li>        <li>l’AddressEditor carica l’Address… </li>     </ol>   </li> </ol>  <span>Boom… siccome siamo bravi, oppure usiamo un ottimo ORM, l’IdentityMap ci frega in curva e ci ridà la stessa reference che ha già caricato in precedenza quindi noi siamo convinti di avere in mano una cosa diversa ma in realtà abbiamo in mano la stessa cosa.</span><br>  <span><strong>“Ma mi facci il Dominio…”</strong> <semi-cit.></span><br>  <span>il problema nel suo insieme è abbastanza evidente, stiamo facendo fare al dominio qualcosa che non è pagato per fare e lui ci frega in corner :-). Manca un attore/mediatore nel mezzo, stiamo usando, ad esempio, Model-View-ViewModel ma non stiamo facendo fare tutto il lavoro al ViewModel (il mediatore)… perchè? perchè all’inizio sembra più facile e veloce :-), implementiamo INotifyPropertyChanged sul dominio e dal ViewModel esponiamo il dominio… e non è bello :-).</span><br>  <span>E’ il ViewModel che deve mettersi in mezzo, implementare lui INotifyPropertyChanged, e fare da mediatore con il dominio. Solo al momento della richiesta di commit da parte dell’utente il ViewModel che dialoga con il dominio deve preoccuparsi di travasare i dati nel dominio stesso.</span><br>  <span><a href="https://lh6.googleusercontent.com/-2Y_eLoaZG7o/Typw3cRGEBI/AAAAAAAAAnw/IRVe5VvesEU/image_10.png" rel="lightbox"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="https://lh3.googleusercontent.com/-nFwvsuWRtaQ/Typw2z41fSI/AAAAAAAAAns/vcRsKvZi7Ts/image_thumb_4.png" width="244" height="188"></a> </span><br>  <span>Questo apparentemente ci salva-dalla-fine-del-mondo, apparentemente perchè sto ancora lavorando sul primo prototipo un po’ complesso per verificare di averle pensate tutte.</span><br>  <span>.m</span><br>
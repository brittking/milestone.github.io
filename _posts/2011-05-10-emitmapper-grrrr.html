---
layout: post
title: EmitMapper… grrrr…
date: '2011-05-10T10:00:00.000+02:00'
author: Mauro Servienti
tags:
- Software Mason
- EmitMapper
modified_time: '2012-02-22T09:21:16.479+01:00'
thumbnail: https://lh3.googleusercontent.com/-zPvqPkBN9ZM/T0SldUc9FKI/AAAAAAAAB2Q/JbWxVEqDkfg/s72-c/wlEmoticon-smile_2_28.png
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-6123196208367064664
blogger_orig_url: http://milestone.topics.it/2011/05/emitmapper-grrrr.html
---

<span>Mauro stai calmo <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="https://lh3.googleusercontent.com/-zPvqPkBN9ZM/T0SldUc9FKI/AAAAAAAAB2Q/JbWxVEqDkfg/wlEmoticon-smile_2_28.png">, questo test non passa…</span><br> <blockquote><pre style="font-family: ; background: white; color: "><font face="Consolas"><font style="font-size: 11.3pt">[<span style="color: "><font color="#2b91af">TestMethod</font></span>]
[<span style="color: "><font color="#2b91af">TestCategory</font></span>( <span style="color: "><font color="#a31515">"EmitMapper"</font></span> )]
<span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">void</font></span> EmitMapper_using_two_mappers_with_same_config_and_same_mapper_manager_should_not_use_one_config_instance()
{<br>     <span style="color: "><font color="#0000ff">var</font></span> manager = <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ObjectMapperManager</font></span>();</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> aMapper = manager.GetMapper<<span style="color: "><font color="#2b91af">ReferencedType</font></span>, <span style="color: "><font color="#2b91af">ReferencedTypeDto</font></span>><br>     (<br>         <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">DefaultMapConfig</font></span>()<br>     );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> anotherMapper = manager.GetMapper<<span style="color: "><font color="#2b91af">ReferencedType</font></span>, <span style="color: "><font color="#2b91af">ReferencedTypeDto</font></span>><br>     (<br>         <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">DefaultMapConfig</font></span>()<br>     );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> aCfg = aMapper.MapperImpl.MappingConfigurator;<br>     <span style="color: "><font color="#0000ff">var</font></span> anotherCfg = anotherMapper.MapperImpl.MappingConfigurator;</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> eq = aCfg.Equals( anotherCfg );<br>     <span style="color: "><font color="#0000ff">var</font></span> refEq = <span style="color: "><font color="#2b91af">Object</font></span>.ReferenceEquals( aCfg, anotherCfg );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     eq.Should().Be.False();<br>     refEq.Should().Be.False();</font></font></pre>}</blockquote>
<span>e che diamine… <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smilewithtongueout" alt="Smile with tongue out" src="https://lh3.googleusercontent.com/-Pea8e2w-4P4/T0SleJs2yrI/AAAAAAAAB2Y/HNL7HOD7_KU/wlEmoticon-smilewithtongueout_2_19.png">, come è possibile?</span><br>
<span>MapperImpl.MappingConfigurator è l’istanza di “DefaultMapConfig” che viene passata all’ObjectsMapperManager in fase di creazione del mapper, facciamo due “new” come è possibile che due mapper diversi abbiano la stessa configurazione?</span><br>
<blockquote>
<span>La prima domanda che potreste fare è: perché mai dovrei aver bisogno di due mapper per gli stessi tipi ma distinti?</span><br>
<span>Domanda più che lecita, in effetti quell’esempio è semplicemente mirato a evidenziare il problema, lo scenario è quello di strategie di mapping diverse per lo stesso tipo in base al contesto, quindi stesso mapper ma configurazioni diverse. Potrei avere il mapper registrato in un container per IoC taggato in qualche modo per far si che se sono in back-office vengo restituito il mapper configurato per il back-office, mentre se sono in front-office venga restituito quello per il front-office.</span><br></blockquote>
<span>Semplice… EmitMapper si prende la libertà di stabilire che la configurazione è strutturalmente uguale e quindi ricicla quella del primo mapper per il secondo. Ora il comportamento ci può anche stare, anche se visto che faccio esplicitamente una “new” il riciclo non dovrebbe proprio avvenire, ma se state pesantemente lavorando sull’estendere la configurazione e non è più che ben chiaro questo meccanismo semplicemente impazzite…maledetto lui <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-confusedsmile" alt="Confused smile" src="https://lh6.googleusercontent.com/-9BMJVB_1PIk/T0Sle2oiCcI/AAAAAAAAB2c/Og090XLFxz0/wlEmoticon-confusedsmile_2_3.png">.</span><br>
<span>Parlerò ampiamente più avanti, e molto male per giunta, della presunta estendibilità di EmitMapper, sta di fatto che il riciclo viene fatto internamente in un modo talmente assurdo che non avete mezzo di metterci mano se non in due modi alquanto bizzarri:</span><br>
<blockquote><pre style="font-family: ; background: white; color: "><font face="Consolas"><font style="font-size: 11.3pt">[<span style="color: "><font color="#2b91af">TestMethod</font></span>]
[<span style="color: "><font color="#2b91af">TestCategory</font></span>( <span style="color: "><font color="#a31515">"EmitMapper"</font></span> )]
<span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">void</font></span> EmitMapper_mapping_using_two_mappers_with_same_config_but_different_mapper_manager_should_not_use_one_config_instance()
{<br>     <span style="color: "><font color="#0000ff">var</font></span> aManager = <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ObjectMapperManager</font></span>();</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> aMapper = aManager.GetMapper<<span style="color: "><font color="#2b91af">ReferencedType</font></span>, <span style="color: "><font color="#2b91af">ReferencedTypeDto</font></span>><br>     (<br>         <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">DefaultMapConfig</font></span>()<br>     );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> anotherManager = <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ObjectMapperManager</font></span>();</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> anotherMapper = anotherManager.GetMapper<<span style="color: "><font color="#2b91af">ReferencedType</font></span>, <span style="color: "><font color="#2b91af">ReferencedTypeDto</font></span>><br>     (<br>         <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">DefaultMapConfig</font></span>()<br>     );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> aCfg = aMapper.MapperImpl.MappingConfigurator;<br>     <span style="color: "><font color="#0000ff">var</font></span> anotherCfg = anotherMapper.MapperImpl.MappingConfigurator;</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> eq = aCfg.Equals( anotherCfg );<br>     <span style="color: "><font color="#0000ff">var</font></span> refEq = <span style="color: "><font color="#2b91af">Object</font></span>.ReferenceEquals( aCfg, anotherCfg );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     eq.Should().Be.False();<br>     refEq.Should().Be.False();</font></font></pre>}</blockquote>
<span>Avere due ObjectsMapperManager, cosa totalmente insensata, oppure banalmente:</span><br>
<blockquote><pre style="font-family: ; background: white; color: "><font face="Consolas"><font style="font-size: 11.3pt">[<span style="color: "><font color="#2b91af">TestMethod</font></span>]
[<span style="color: "><font color="#2b91af">TestCategory</font></span>( <span style="color: "><font color="#a31515">"EmitMapper"</font></span> )]
<span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">void</font></span> EmitMapper_mapping_using_two_mappers_with_same_config_and_different_name_but_same_mapper_manager_should_not_use_one_config_instance()
{<br>     <span style="color: "><font color="#0000ff">var</font></span> manager = <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ObjectMapperManager</font></span>();</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> aMapper = manager.GetMapper<<span style="color: "><font color="#2b91af">ReferencedType</font></span>, <span style="color: "><font color="#2b91af">ReferencedTypeDto</font></span>><br>     (<br>         <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">DefaultMapConfig</font></span>().SetConfigName( <span style="color: "><font color="#a31515">"aMapper-unique-name"</font></span> )<br>     );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> anotherMapper = manager.GetMapper<<span style="color: "><font color="#2b91af">ReferencedType</font></span>, <span style="color: "><font color="#2b91af">ReferencedTypeDto</font></span>><br>     (<br>         <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">DefaultMapConfig</font></span>().SetConfigName( <span style="color: "><font color="#a31515">"anotherMapper-unique-name"</font></span> )<br>     );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> aCfg = aMapper.MapperImpl.MappingConfigurator;<br>     <span style="color: "><font color="#0000ff">var</font></span> anotherCfg = anotherMapper.MapperImpl.MappingConfigurator;</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> eq = aCfg.Equals( anotherCfg );<br>     <span style="color: "><font color="#0000ff">var</font></span> refEq = <span style="color: "><font color="#2b91af">Object</font></span>.ReferenceEquals( aCfg, anotherCfg );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     eq.Should().Be.False();<br>     refEq.Should().Be.False();</font></font></pre>}</blockquote>
<span>Dare un nome univoco alla configurazione…</span><br>
<span>.m</span><br>
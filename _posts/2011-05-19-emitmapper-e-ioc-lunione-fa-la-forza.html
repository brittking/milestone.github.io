---
layout: post
title: 'EmitMapper e IoC: l’unione fa la forza'
date: '2011-05-19T13:44:00.000+02:00'
author: Mauro Servienti
tags:
- Software Mason
- Architecture
- EmitMapper
- Extensibility
modified_time: '2012-02-22T09:21:50.751+01:00'
thumbnail: https://lh6.googleusercontent.com/-Av1QQulgKWM/T0SlmvJjH8I/AAAAAAAAB3Y/TcQqYk9rQk8/s72-c/wlEmoticon-smile_2_30.png
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-8724324827058101941
blogger_orig_url: http://milestone.topics.it/2011/05/emitmapper-e-ioc-lunione-fa-la-forza.html
---

<span>…e compensa un po’ di <a href="http://mauroservienti.blogspot.com/2011/05/pensare-lestendibilita-non-basta-il.html" target="_blank">magagne di EmitMapper</a>, questo test fallisce:</span><br> <blockquote><pre style="font-family: ; background: white; color: "><font face="Consolas"><font style="font-size: 11.3pt">[<span style="color: "><font color="#2b91af">TestMethod</font></span>]
[<span style="color: "><font color="#2b91af">TestCategory</font></span>( <span style="color: "><font color="#a31515">"EmitMapper"</font></span> )]
<span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">void</font></span> EmitMapper_does_not_user_mapper_manager_to_provide_mappers()
{<br>     <span style="color: "><font color="#0000ff">var</font></span> actual = <span style="color: "><font color="#0000ff">false</font></span>;<br>     <span style="color: "><font color="#2b91af">ObjectMapperManager</font></span> mm = <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ObjectMapperManager</font></span>();</font></font></pre><pre style="font-family: ; background: white; color: "><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> m = mm.GetMapper<<span style="color: "><font color="#2b91af">ReferencedType</font></span>, <span style="color: "><font color="#2b91af">ReferencedTypeDto</font></span>><br>     (<br>         <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">DefaultMapConfig</font></span>()<br>             .ConvertUsing<<span style="color: "><font color="#0000ff">int</font></span>, <span style="color: "><font color="#0000ff">int</font></span>>( i =><br>             {<br>                 actual = <span style="color: "><font color="#0000ff">true</font></span>;<br>                 <span style="color: "><font color="#0000ff">return</font></span> i;<br>             } )<br>     );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> sut = mm.GetMapper<<span style="color: "><font color="#2b91af">SpecialCategory</font></span>, <span style="color: "><font color="#2b91af">SpecialCategoryDto</font></span>><br>     (<br>         <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">DefaultMapConfig</font></span>()<br>             .DeepMap()<br>             .ConvertUsing<<span style="color: "><font color="#2b91af">Category</font></span>, <span style="color: "><font color="#2b91af">Int32</font></span>>( ei => ei == <span style="color: "><font color="#0000ff">null</font></span> ? -1 : ei.Id )<br>     );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> sc = <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">SpecialCategory</font></span>()<br>     {<br>         Id = 0,<br>         Name = <span style="color: "><font color="#a31515">"Special Category"</font></span>,<br>         Parent = <span style="color: "><font color="#0000ff">null</font></span>,<br>         IsValid = <span style="color: "><font color="#0000ff">true<br></font></span>     };</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     sc.ReferencedTypes.Add( <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ReferencedType</font></span>() { Foo = 12 } );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> dto = sut.Map( sc );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     actual.Should().Be.True();</font></font></pre>}</blockquote>
<span>In soldoni l’ObjectsMapperManager non serve ad una emerita cippa… <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="https://lh6.googleusercontent.com/-Av1QQulgKWM/T0SlmvJjH8I/AAAAAAAAB3Y/TcQqYk9rQk8/wlEmoticon-smile_2_30.png">, quello che mi aspetterei è che se il “manager” ha un mapper definito per un tipo di conversione lo usi, invece no, ne crea uno internamente e vi rimbalza <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-confusedsmile" alt="Confused smile" src="https://lh3.googleusercontent.com/-9lKzLZR06Ek/T0SlnZBdjcI/AAAAAAAAB3c/shxMypkAkiA/wlEmoticon-confusedsmile_2_5.png"></span><br>
<span>Vista l’esperienza fatta con l’estensione per gestire le liste non mi ci sono neanche messo a capire perché, semplicemente ho esteso la mia configurazione custom per supportare l’iniezione di un container per IoC da interrogare per sapere se esiste un mapper per soddisfare la necessità:</span><br>
<blockquote><pre style="font-family: ; background: white; color: "><font face="Consolas"><font style="font-size: 11.3pt">[<span style="color: "><font color="#2b91af">TestMethod</font></span>]
[<span style="color: "><font color="#2b91af">TestCategory</font></span>( <span style="color: "><font color="#a31515">"EmitMapper"</font></span> )]
<span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#0000ff">void</font></span> EmitMapper_extendedMapConfig_should_be_able_to_resolve_mappers_using_IServiceProvider()
{<br>     <span style="color: "><font color="#0000ff">var</font></span> actual = <span style="color: "><font color="#0000ff">false</font></span>;<br>     <span style="color: "><font color="#2b91af">ObjectMapperManager</font></span> mm = <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ObjectMapperManager</font></span>();</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#2b91af">IServiceProvider</font></span> container = <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">MyServiceProvider</font></span>( t =><br>     {<br>         <span style="color: "><font color="#0000ff">var</font></span> m = mm.GetMapper<<span style="color: "><font color="#2b91af">ReferencedType</font></span>, <span style="color: "><font color="#2b91af">ReferencedTypeDto</font></span>><br>         (<br>             <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">DefaultMapConfig</font></span>()<br>                 .ConvertUsing<<span style="color: "><font color="#0000ff">int</font></span>, <span style="color: "><font color="#0000ff">int</font></span>>( i =><br>                 {<br>                     <span style="color: "><font color="#0000ff">return</font></span> i;<br>                 } )<br>         );<br>         actual = <span style="color: "><font color="#0000ff">true</font></span>;<br>         <span style="color: "><font color="#0000ff">return</font></span> m;<br>     } );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> sut = mm.GetMapper<<span style="color: "><font color="#2b91af">SpecialCategory</font></span>, <span style="color: "><font color="#2b91af">SpecialCategoryDto</font></span>><br>     (<br>         <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">MappingConfiguration</font></span>( mm )<br>             .ResolveSubMappersUsing( container )<br>             .DeepMap()<br>             .ConvertUsing<<span style="color: "><font color="#2b91af">Category</font></span>, <span style="color: "><font color="#2b91af">Int32</font></span>>( ei => ei == <span style="color: "><font color="#0000ff">null</font></span> ? -1 : ei.Id )<br>     );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> sc = <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">SpecialCategory</font></span>()<br>     {<br>         Id = 0,<br>         Name = <span style="color: "><font color="#a31515">"Special Category"</font></span>,<br>         Parent = <span style="color: "><font color="#0000ff">null</font></span>,<br>         IsValid = <span style="color: "><font color="#0000ff">true<br></font></span>     };</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     sc.ReferencedTypes.Add( <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ReferencedType</font></span>() { Foo = 12 } );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     <span style="color: "><font color="#0000ff">var</font></span> dto = sut.Map( sc );</font></font></pre><pre style="font-family: ; background: white"><font face="Consolas"><font style="font-size: 11.3pt">     actual.Should().Be.True();</font></font></pre>}</blockquote>
<span>Il tutto è definitivamente diventato un estensione per EmitMapper presente in <a href="http://radical.codeplex.com/" target="_blank">Radical</a>.</span><br>
<span>.m</span><br>
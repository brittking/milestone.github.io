---
layout: post
title: Running RavenDB as a Windows Azure worker role
date: '2012-11-07T10:08:00.000+01:00'
author: Mauro Servienti
tags:
- RavenDB
- Azure
modified_time: '2012-11-07T10:08:00.224+01:00'
thumbnail: http://lh4.ggpht.com/-Bcm4VetU8PE/UIurwQB3n2I/AAAAAAAACRQ/hnZmspDp5Y0/s72-c/image_thumb.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-377790062637078603
blogger_orig_url: http://milestone.topics.it/2012/11/running-ravendb-as-windows-azure-worker.html
---

<p>A perfect starting point to run <a href="http://ravendb.net" target="_blank">RavenDB</a> on Windows <a href="http://www.windowsazure.com/" target="_blank">Azure</a> as a worker role is <a href="https://github.com/SaschaDittmann/RavenDbOnAzure" target="_blank">this project</a> hosted on <a href="https://github.com" target="_blank">GitHub</a>.</p> <p><strong>Why?</strong></p> <p>There is no particular reason to run RavenDB on Azure:</p> <ul> <li>we are really confident with RavenDB;  <li>we have already experienced the power of a document database;  <li>we are not so confident with <a href="http://www.mongodb.org/" target="_blank">MongoDB</a> and especially:  <ul> <li>we currently do not really like that in order to run MongoDB on Azure we are required to set it up in a non-already supported Azure Virtual machine;  <li>10gen is also working on a <a href="http://www.mongodb.org/display/DOCS/MongoDB+on+Azure+Worker+Roles" target="_blank">MongoDB Worker Role</a> that is now in beta, so in the near future MongoDB will be a really interesting alternative.</li></ul> <li>we need to be able to set geography constraints, due to privacy requirements, on where our data are stored;</li></ul> <p><strong>Requirements</strong></p> <p>Our requirements are really simple:</p> <ol> <li>we need to be able to run on Esent, and not on Munin that is not really supported for production environments;  <li>in order to provide some sort of SLA to our customer we need to be able to setup replica using other worker roles;</li></ol> <p><strong>Changes</strong></p> <p>If you download the above sample from github and press F5 in Visual Studio it simply works but after a deeper look it does not satisfies the above requirements:</p> <ul> <li>on my machine the startup of the second role to setup the replication silently fails;  <li>the sample runs on Munin and simply switching to Esent in the RavenDB configuration breaks everything;</li></ul> <p>in order to fix and have everything setup and running we followed this steps:</p> <ul> <li>In order to run on Esent when dealing with Azure Blob storage and VHD(s):  <ul> <li>The “Data” directory must be “manually” created otherwise Esent complains with a “Disk IO Error”;  <li>The “Tenants” directory must be “manually” created, in order to avoid the same issue as above;</li></ul> <li>The downloaded sample:  <ul> <li>has a misconfigured endpoint in the role configuration: the endpoint must be http and not tcp;  <li>utilizes the “RoleEnvironment.CurrentRoleInstance.Id” to setup the VHD name but, at least in the development emulator, the id changes at each deployment and is prefixed with the deployment id, thus each time the VHD is new and you lose access to the previous debug session data; we managed to create a VHD name using “RoleEnvironment.CurrentRoleInstance.Id” value but removing the “RoleEnvironment.DeploymentId” portion;  <li>In <u>my</u> environment running with more than 1 instance breaks everything because of the way the emulator assigns dynamic ports to the second instance, resulting in the choice of an already used port, I suppose it does something like “current port” + 1, thus 8080 + 1 = 8081;  <li>I have also removed all the references to the embedded RavenDB version that in our scenario is useless;</li></ul></li></ul> <p>Now everything runs and satisfies our requirements and we can point the browser to the local emulator address and see the RavenDB Studio up and running:</p> <p><a href="http://lh5.ggpht.com/-nPz_SyZ4NkM/UIurvY2co8I/AAAAAAAACRM/54DrnXDdeHQ/s1600-h/image%25255B2%25255D.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://lh4.ggpht.com/-Bcm4VetU8PE/UIurwQB3n2I/AAAAAAAACRQ/hnZmspDp5Y0/image_thumb.png?imgmax=800" width="244" height="122"></a></p> <p>.m</p>  
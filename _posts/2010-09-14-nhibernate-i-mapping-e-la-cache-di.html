---
layout: post
title: NHibernate, i mapping e la cache di secondo livello
date: '2010-09-14T11:30:00.000+02:00'
author: Mauro Servienti
tags:
- Software Mason
- NHibernate
modified_time: '2012-02-20T12:19:06.839+01:00'
thumbnail: https://lh6.googleusercontent.com/-MYLL3rO1Bs4/T0IsB95sz0I/AAAAAAAABpI/7nuh63SU3EA/s72-c/wlEmoticon-smile_2_7.png
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-622984745882993495
blogger_orig_url: http://milestone.topics.it/2010/09/nhibernate-i-mapping-e-la-cache-di.html
permalink: /2010/09/nhibernate-i-mapping-e-la-cache-di.html
---

<span>Developer avvisato developer mezzo salvato <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="https://lh6.googleusercontent.com/-MYLL3rO1Bs4/T0IsB95sz0I/AAAAAAAABpI/7nuh63SU3EA/wlEmoticon-smile_2_7.png"></span><br>  <span>Abbiamo un modello di questo genere, fondamentalmente un “albero” con delle “foglie”, foglie che a loro volta possono avere degli attributi:</span><br>  <span><a href="https://lh4.googleusercontent.com/-Ayh8pA9U77s/T0IsC926aUI/AAAAAAAABpY/D3OBYrwSaoE/image_6_1.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://lh4.googleusercontent.com/-4y_UbMMS92w/T0IsCcrI5cI/AAAAAAAABpM/43WS7_9woTg/image_thumb_2_2.png" width="234" height="244"></a></span><br>  <span>Questo modello è mappato su una struttura relazionale di questo genere:</span><br>  <span><a href="https://lh5.googleusercontent.com/-Qh7nxyij-Q0/T0IsEH9G50I/AAAAAAAABpo/3uFnu0lpoXA/image_8_1.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://lh6.googleusercontent.com/-0hEOLc0jBK4/T0IsDfyCo8I/AAAAAAAABpc/3-H0rgDMdfA/image_thumb_3_2.png" width="199" height="244"></a></span><br>  <span>C’è un buon motivo per cui sul db la relazione è tra <em>EntityAttribute</em> e <em>DomainEntity</em> mentre nel dominio è esplicitata su ogni singola entità, ma non è oggetto del contendere odierno <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="d5436198-aeeb-4fa2-8e1b-6f7f187fca79"></span><br>  <span>Il tutto è mapato con il fido <a href="http://nhforge.org/" target="_blank">NHibernate</a> e nei mapping/configurazione è stata attivato il supporto per la cache di secondo livello, facendo un po’ di prove però il Tool per eccellenza <a href="http://nhprof.com" target="_blank">NH Proof</a> (spettacolo, siamo inseparabili ormai <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-smilewithtongueout" alt="Smile with tongue out" src="https://lh5.googleusercontent.com/--PaDdoH1PNk/T0IsFpnM-7I/AAAAAAAABpw/dGYKtjT01IY/wlEmoticon-smilewithtongueout_2_2.png">) mi diceva che qualcosa non stava andando come doveva…</span><br>  <span><a href="https://lh5.googleusercontent.com/-1KOJd0XNW6I/T0IsHNBWZiI/AAAAAAAABp8/MZ1-xQ77Dmc/image_4_3.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://lh5.googleusercontent.com/-a35VGDdSG70/T0IsGfLZdmI/AAAAAAAABp0/7NWHUGYOrek/image_thumb_1_3.png" width="244" height="86"></a></span><br>  <span>Succedeva una cosa decisamente curiosa, richieste successive, identiche, producevano un numero di query maggiore di quello della prima richiesta e solo una parte dei dati veniva effetivamente preso dalla cache di secondo livello.</span><br>  <span>L’applicazione è un servizio WCF ad uso e consumo del <a href="http://www.gaia.is.it" target="_blank">nostro</a> CRM, applicazione web, e nello specifico deve ritornare un set di DTO gerarchico che rappresenta le informazioni cercate, il tutto facendo il minor numero possibile di roundtrip verso il db (possibilemente evitando però delle join mostruosoe… <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="04fddc7d-92b2-4107-8d0a-9a72c6ccf4d3">)</span><br>  <span>Alla fine spulciando e studiando, in particolare come funziona il sistema di mapping di NHibernate, ho capito che è essenziale istruirlo affinchè vengano cachate anche le relazioni:</span><br>  <blockquote>   <pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.HasMany( z => z.ChildZones )</font></font><br><font face="Consolas"><font style="font-size: 12pt">	.LazyLoad()</font></font><br><font face="Consolas"><font style="font-size: 12pt">	…</font></font><br><font face="Consolas"><font style="font-size: 12pt">	.<strong>Cache.ReadWrite</strong>();</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.HasMany( z => z.Branches )</font></font><br><font face="Consolas"><font style="font-size: 12pt">	.LazyLoad()</font></font><br><font face="Consolas"><font style="font-size: 12pt">	…</font></font><br><font face="Consolas"><font style="font-size: 12pt">	.<strong>Cache.ReadWrite</strong>();</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.HasMany( z => z.Attributes )</font></font><br><font face="Consolas"><font style="font-size: 12pt">	.LazyLoad()</font></font><br><font face="Consolas"><font style="font-size: 12pt">	…</font></font><br><font face="Consolas"><font style="font-size: 12pt">	.<strong>Cache.ReadWrite</strong>();</font></font></pre>
</blockquote>

<span>fatto questo “magicamente” il profiler ci dice che non stiamo più toccando inutilmente il db:</span><br>

<span><a href="https://lh4.googleusercontent.com/-Q8DBZ9TA8gg/T0IsIndbqGI/AAAAAAAABqM/WAP8QqtBqhY/image_2_4.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://lh4.googleusercontent.com/-pz9pmdVqOAY/T0IsHj1TXVI/AAAAAAAABqI/314v4dH-iEY/image_thumb_5.png" width="244" height="82"></a></span><br>

<span><em>Il boost dei tempi è percentualmente significativo, in assoluto non ancora perchè le righe sono pochissime.</em></span><br>

<span>Al primo giro carichiamo quello che ci serve poi tutto viene correttamente cachato e infatti le richieste successive non toccano più il db ma usano sempre e solo la cache, come si evince anche dalla lista degli statements:</span><br>

<span><a href="https://lh4.googleusercontent.com/-Q4ZQ8NqtbCg/T0IsKHZ9QvI/AAAAAAAABqg/m_Zh2l7yzIQ/image_10.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://lh4.googleusercontent.com/-WLZIv6GUiEY/T0IsJYbsnuI/AAAAAAAABqU/0GEPe_Trv4c/image_thumb_4_1.png" width="244" height="142"></a></span><br>

<span>.m</span><br>

---
layout: post
title: 'RavenDB Worker Role on Windows Azure: create service users'
date: '2013-04-03T13:54:00.000+02:00'
author: Mauro Servienti
tags:
- RavenDB
- Azure
modified_time: '2013-04-03T13:54:00.276+02:00'
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-7451734358498891281
blogger_orig_url: http://milestone.topics.it/2013/04/ravendb-worker-role-on-windows-azure.html
---

<p>When creating a Worker Role on Windows <a href="http://www.windowsazure.com/" target="_blank">Azure</a>, due to the nature of the worker role, we need to be fully auto-consistent: each time the role is deployed (or re-imaged) into the Azure infrastructure a brand new virtual machine is created to host the role thus if the role needs, in order to work, some OS customization we need to do those customizations at role startup.</p> <p><a href="http://msdn.microsoft.com/en-us/library/windowsazure/gg456327.aspx" target="_blank">Startup tasks</a> are provided exactly to achieve that.</p> <p>In order to setup <a href="http://ravendb.net" target="_blank">RavenDB</a>, when using Windows Authentication, you need at least 2 users:</p> <ul> <li>An administrator to perform administrative tasks, such as backups or system level operations;</li> <li>A standard user in order to connect and operate on a database;</li></ul> <p>Each time the role is deployed users must be created on the newly deployed virtual machine.</p> <p>A startup task is a <strong>separate process</strong> that can be launched at role startup, the task definition is created in the “ServiceDefinition.csdef” file:</p> <blockquote> <div id="codeSnippetWrapper"><pre id="codeSnippet" style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: 'Courier New', courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4"><span style="color: #0000ff">&lt;</span><span style="color: #800000">Startup</span><span style="color: #0000ff">&gt;</span><br>      <span style="color: #0000ff">&lt;</span><span style="color: #800000">Task</span> <span style="color: #ff0000">commandLine</span><span style="color: #0000ff">="Startup\CreateWindowsUser.exe"</span> <span style="color: #ff0000">executionContext</span><span style="color: #0000ff">="elevated"</span> <span style="color: #ff0000">taskType</span><span style="color: #0000ff">="simple"</span><span style="color: #0000ff">&gt;</span><br>        <span style="color: #0000ff">&lt;</span><span style="color: #800000">Environment</span><span style="color: #0000ff">&gt;</span><br>          <span style="color: #0000ff">&lt;</span><span style="color: #800000">Variable</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="emulated"</span><span style="color: #0000ff">&gt;</span><br>            <span style="color: #0000ff">&lt;</span><span style="color: #800000">RoleInstanceValue</span> <span style="color: #ff0000">xpath</span><span style="color: #0000ff">="/RoleEnvironment/Deployment/@emulated"</span> <span style="color: #0000ff">/&gt;</span><br>          <span style="color: #0000ff">&lt;/</span><span style="color: #800000">Variable</span><span style="color: #0000ff">&gt;</span><br>          <span style="color: #0000ff">&lt;</span><span style="color: #800000">Variable</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="username"</span><span style="color: #0000ff">&gt;</span><br>            <span style="color: #0000ff">&lt;</span><span style="color: #800000">RoleInstanceValue</span> <span style="color: #ff0000">xpath</span><span style="color: #0000ff">="/RoleEnvironment/CurrentInstance/ConfigurationSettings/ConfigurationSetting[@name='RavenUserUsername']/@value"</span> <span style="color: #0000ff">/&gt;</span><br>          <span style="color: #0000ff">&lt;/</span><span style="color: #800000">Variable</span><span style="color: #0000ff">&gt;</span><br>          <span style="color: #0000ff">&lt;</span><span style="color: #800000">Variable</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="password"</span><span style="color: #0000ff">&gt;</span><br>            <span style="color: #0000ff">&lt;</span><span style="color: #800000">RoleInstanceValue</span> <span style="color: #ff0000">xpath</span><span style="color: #0000ff">="/RoleEnvironment/CurrentInstance/ConfigurationSettings/ConfigurationSetting[@name='RavenUserPassword']/@value"</span> <span style="color: #0000ff">/&gt;</span><br>          <span style="color: #0000ff">&lt;/</span><span style="color: #800000">Variable</span><span style="color: #0000ff">&gt;</span><br>          <span style="color: #0000ff">&lt;</span><span style="color: #800000">Variable</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="admin"</span> <span style="color: #ff0000">value</span><span style="color: #0000ff">="False"</span> <span style="color: #0000ff">/&gt;</span><br>        <span style="color: #0000ff">&lt;/</span><span style="color: #800000">Environment</span><span style="color: #0000ff">&gt;</span><br>      <span style="color: #0000ff">&lt;/</span><span style="color: #800000">Task</span><span style="color: #0000ff">&gt;</span><br><span style="color: #0000ff">&lt;/</span><span style="color: #800000">Startup</span><span style="color: #0000ff">&gt;</span></pre><br></div></blockquote>
<p>As you can see we are calling an external process, with elevation, and we’ll wait for the process to complete before moving on (simple taskType); if we need to pass information, defined in the role settings, to the external task the only way, as far as I know, is to use a shared environment variable. In this sample we are passing to the external task the username and password of the user we need to create, a flag that indicates if the user should be an administrator or not, and a flag that tells to the external process if we are running in the Azure emulator or not.</p>
<p>We can launch as many tasks as we want, and in the real scenario we are launching the above task 2 times, with different parameters, in order to create the 2 required users.</p>
<p>The external process does nothing special, it just creates a user, using the provided info, via the System.DirectoryServices.AccountManagement namespace classes.</p>
<p>.m</p>  
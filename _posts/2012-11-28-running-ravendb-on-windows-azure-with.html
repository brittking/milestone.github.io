---
layout: post
title: Running RavenDB on Windows Azure with Replica
date: '2012-11-28T13:10:00.000+01:00'
author: Mauro Servienti
tags:
- RavenDB
- Azure
modified_time: '2012-11-28T13:10:00.092+01:00'
thumbnail: http://lh4.ggpht.com/-eImENtihsnA/UKCU2QCqlwI/AAAAAAAACV8/5ZqMdIhHuP4/s72-c/image_thumb%25255B137%25255D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-3081342710105134537
blogger_orig_url: http://milestone.topics.it/2012/11/running-ravendb-on-windows-azure-with.html
permalink: /2012/11/running-ravendb-on-windows-azure-with.html
---

<p>We <a href="{{ site.baseurl }}{% post_url 2012-11-15-running-ravendb-on-windows-azure-using %}">have seen how easy</a> is to setup <a href="http://ravendb.net" target="_blank">RavenDB</a> on <a href="http://www.windowsazure.com/" target="_blank">Azure</a> using a Virtual Machine, nothing so different from what we would do on a regular on premise VM/bare metal.</p> <blockquote> <p><em>The funniest thing is that the RavenDB configuration for replica is just a matter of seconds, the time consuming part is the Azure configuration.</em></p></blockquote> <p><strong>Service Level Agreement</strong></p> <p>One of the key point of providing a service in the cloud is to give to our customer a SLA, a guarantee that the service we provide with our application will be available whenever the customer needs it.</p> <p>Using Azure Web/Worker Role(s) it is a trivial stuff, just deploy more instance of the same role, but with VM is up to us to manage the whole topology of the network and to setup VM balancing, if required, and redundancy.</p> <p><strong>Why running in a VM?</strong></p> <p>We <a href="{{ site.baseurl }}{% post_url 2012-11-07-running-ravendb-as-windows-azure-worker %}">have seen that we can easily setup RavenDB using a Worker Role</a> but </p> <p><strong>RavenDB Replica support</strong></p> <p>Using RavenDB we can leverage the power and simplicity of the Replication Bundle so set up a replica-set, let’s say that we want to setup the simplest possible scenario: master-slave.</p> <p>First of all we need another virtual machine, can we “copy” the already existing one: yes, but wait a minute.</p> <p><strong>Azure networking</strong></p> <p>The first problem we have is to understand how we can allow communication between virtual machines laying in an Azure datacenter. There a re a couple of possible approach:</p> <ul> <li><strong>Availability Set</strong>: Azure has the concept of availability set, a sort of logical grouping, and the documentation states that virtual machines (and so also web and worker roles) living in the same availability set, or defined in the same cloud service, are able to communicate without any configuration (other than the machine on board firewall that obviously should be configured to accomplish your needs)…I have tried everything without any success… :-/</li> <li><strong>Virtual Network</strong>: Azure has recently introduced the concept of virtual networks, it is basically a network definition that guarantees isolation and communication to the machines defined in the virtual network, the amazing thing, even if out of our current scope, is that we can use virtual networks to create a network between the cloud network and our on premise network. </li></ul> <p>The main difference, as per the documentation, between the two is that in the first one we get name resolution for free and in the second one we should provide our own DNS service to have name resolution, but in order to setup the replica we can use machine IP addresses and the Virtual Network gives us something called persistent IP, a sort of a DHCP infinite lease; so we do not need any DNS to setup the replica.</p> <p>At the time of this writing the biggest problem of the Virtual Networks is that there is no support to add an existing VM to a virtual network, we need to add the VM to the network at creation time.</p> <p><strong>Create the Virtual Network</strong></p> <p>Since we need to define the Virtual Network before creating the VMs the first step is to create di network, via the Azure management portal go to the network tab:</p> <p><a href="http://lh5.ggpht.com/-ouriRcjvQ3Y/UKCU1GBg5KI/AAAAAAAACV0/Z-FCQsCrrrg/s1600-h/image%25255B153%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://lh4.ggpht.com/-eImENtihsnA/UKCU2QCqlwI/AAAAAAAACV8/5ZqMdIhHuP4/image_thumb%25255B137%25255D.png?imgmax=800" width="264" height="184"></a></p> <p>And create a new network, I skip the 2 creation steps since they are just a network definition made of a name, an address space and a optional subnet.</p> <p><strong>Shutdown the VM and Capture it</strong></p> <p>Now…we have a running VM that cannot be added to the virtual network and we need another VM with exactly the same configuration, the easiest approach is:</p> <ul> <li>“Sysprep” the OS, running sysprep.exe from Windows\System32\Sysprep, choosing the following options:<br><a href="http://lh3.ggpht.com/-sQ_aygXih2I/UKCU3kXw-AI/AAAAAAAACWA/rirn_4HhOoI/s1600-h/image%25255B5%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://lh4.ggpht.com/-4EOpZK2TUsY/UKCU4lM9p5I/AAAAAAAACWM/s8CLW8tx2yk/image_thumb%25255B1%25255D.png?imgmax=800" width="244" height="189"></a></li> <li>Wait for the sysprep process to complete, wait, wait, wait…I waited for 15 minutes…it’s along way to the top…;</li> <li>Use the capture function of the Azure portal to create a image of the VM, once the capture is completed:</li> <ul> <li>The original VM is deleted;</li> <li>You have a new image in the gallery ready to use to create ne VMs;</li></ul></ul> <p><strong>Create 2 VMs based on the captured image</strong></p> <p>Create 2 new VMs using the previously created image and be sure to add the VM the existing virtual network:</p> <p><a href="http://lh4.ggpht.com/-CoLBL-fOfAQ/UKCU6mwR-6I/AAAAAAAACWU/Wd26fKFO9zc/s1600-h/image%25255B152%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://lh4.ggpht.com/-QaIJlVisbAg/UKCU8CITaUI/AAAAAAAACWc/FfwecuBIRAo/image_thumb%25255B136%25255D.png?imgmax=800" width="264" height="197"></a></p> <p>Once the VM is up &amp; running and the installed RavenDB is accessible from the internet (be sure as in the single machine installation to add the both the VMs an http endpoint as usual) go to the Azure portal and take a look at the network configuration of the machines:</p> <p><a href="http://lh4.ggpht.com/-qGLdiMhNsjo/UKCU-SOSqWI/AAAAAAAACWk/iw0ooW_2Si0/s1600-h/image%25255B132%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://lh3.ggpht.com/-ZejLsnyxvF0/UKCU_yd7SUI/AAAAAAAACWo/qrqhxlG5UHw/image_thumb%25255B116%25255D.png?imgmax=800" width="354" height="126"></a></p> <p>Both machines have an internal IP address that belongs to the subnet mask defined in the virtual network.</p> <p><strong>Setup RavenDB replica</strong></p> <p>Install the Replication Bundle on both machines adding the Raven.Bundles.Replication assembly to the Plugins directory, now go to the RavenDB Studio of the machine that will be the master server, select the database you want to replicate the the slave server and create the replica setup document:</p> <p><a href="http://lh3.ggpht.com/-0V8G59eSBrY/UKCVBoi0D8I/AAAAAAAACW0/cRQGgWYbSiI/s1600-h/image%25255B119%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://lh5.ggpht.com/-P3VdDKrU0Uw/UKCVDPCk0KI/AAAAAAAACW8/8hFuVBs09s4/image_thumb%25255B103%25255D.png?imgmax=800" width="354" height="186"></a></p> <p>We also add credentials info the the document since we are using Windows Authentication, there is also a option to specify a connection string in the web config and thus encrypt the config section for security purpose.</p> <p>As soon as you save the document if you move to the Logs tab of the Studio you can see that RavenDB has immediately noticed that something interesting has happened:</p> <p><a href="http://lh3.ggpht.com/-yj29N5aPvWE/UKCVE9vT1YI/AAAAAAAACXE/iYJXBIlRxEo/s1600-h/image%25255B59%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://lh5.ggpht.com/-qa6L6NnqqpA/UKCVG2nVeXI/AAAAAAAACXM/Zka9mF7Fe0Q/image_thumb%25255B43%25255D.png?imgmax=800" width="354" height="86"></a></p> <p>The final step is to test everything, pop up a new browser pointing to the slave server, go back to the master and create a new document:</p> <p><a href="http://lh5.ggpht.com/-DZVltKvumWE/UKCVJNJACdI/AAAAAAAACXU/B33o7G1M5Qs/s1600-h/image%25255B31%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://lh4.ggpht.com/-j3nq6ReN0jU/UKCVLMcPO0I/AAAAAAAACXc/2W4EFkIwEWY/image_thumb%25255B15%25255D.png?imgmax=800" width="354" height="221"></a></p> <p>A couple of seconds after we created the new document (with id “Users/3”) on the primary server the same document pops up on the slave one, and the log on the master server confirms that everything is running as expected:</p> <p><a href="http://lh5.ggpht.com/-i1rorQNedec/UKCVMlD-SzI/AAAAAAAACXk/LFV5Sf3SNBU/s1600-h/image%25255B29%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://lh3.ggpht.com/-wI4oixQ2Lfs/UKCVN-FLDmI/AAAAAAAACXs/D6uVZoMEmCI/image_thumb%25255B13%25255D.png?imgmax=800" width="354" height="84"></a></p> <p>Amazing, all this stuff is simply amazing :-P</p> <p>.m</p>  

---
layout: post
title: 'NHibernate: come si chiama quell’Alias?'
date: '2010-09-16T09:48:00.000+02:00'
author: Mauro Servienti
tags:
- Software Mason
- NHibernate
modified_time: '2012-02-20T12:19:28.282+01:00'
thumbnail: https://lh5.googleusercontent.com/-ezt4LbddOys/T0IsLgXsr8I/AAAAAAAABqo/jQF17corKiQ/s72-c/image_thumb_7.png
blogger_id: tag:blogger.com,1999:blog-6511237790974218081.post-8216602049716707041
blogger_orig_url: http://milestone.topics.it/2010/09/nhibernate-come-si-chiama-quellalias.html
---

<span>dicamo che avete un dominio come questo:</span><br>  <span><a href="https://lh3.googleusercontent.com/-CutO20GKVfQ/T0IsMPrAz2I/AAAAAAAABqs/Wh5BTXVYgR0/image_2_6.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://lh5.googleusercontent.com/-ezt4LbddOys/T0IsLgXsr8I/AAAAAAAABqo/jQF17corKiQ/image_thumb_7.png" width="236" height="244"></a></span><br>  <span>e che questo dominio sta dietro un servizio WCF che espone un set di operazioni tra cui una di questo genere:</span><br>  <blockquote>   <pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><span><font style="font-size: 12pt" color="#808080">///</font></span><span><font style="font-size: 12pt" color="#008000"> </font></span><span><font style="font-size: 12pt" color="#808080"><summary></font></span></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#808080">///</font></span><span><font style="font-size: 12pt" color="#008000"> Finds all the branches that satisfies the given query.</font></span></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#808080">///</font></span><span><font style="font-size: 12pt" color="#008000"> </font></span><span><font style="font-size: 12pt" color="#808080"></summary></font></span></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#808080">///</font></span><span><font style="font-size: 12pt" color="#008000"> </font></span><span><font style="font-size: 12pt" color="#808080"><param name=</font></span><span><font style="font-size: 12pt" color="#808080">"culture"</font></span><span><font style="font-size: 12pt" color="#808080">></font></span><span><font style="font-size: 12pt" color="#008000">The culture.</font></span><span><font style="font-size: 12pt" color="#808080"></param></font></span></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#808080">///</font></span><span><font style="font-size: 12pt" color="#008000"> </font></span><span><font style="font-size: 12pt" color="#808080"><param name=</font></span><span><font style="font-size: 12pt" color="#808080">"queryDto"</font></span><span><font style="font-size: 12pt" color="#808080">></font></span><span><font style="font-size: 12pt" color="#008000">The query dto.</font></span><span><font style="font-size: 12pt" color="#808080"></param></font></span></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#808080">///</font></span><span><font style="font-size: 12pt" color="#008000"> </font></span><span><font style="font-size: 12pt" color="#808080"><returns></font></span></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#808080">///</font></span><span><font style="font-size: 12pt" color="#008000"> A list of branches that satisfies the given criteria.</font></span></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#808080">///</font></span><span><font style="font-size: 12pt" color="#008000"> </font></span><span><font style="font-size: 12pt" color="#808080"></returns></font></span></font><br><font face="Consolas"><font style="font-size: 12pt">[</font><span><font style="font-size: 12pt" color="#2b91af">OperationContract</font></span><font style="font-size: 12pt">( Name = </font><span><font style="font-size: 12pt" color="#a31515">"FindBranchesByQuery"</font></span><font style="font-size: 12pt"> )]</font></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#2b91af">BranchDto</font></span><font style="font-size: 12pt">[] FindBranches( </font><span><font style="font-size: 12pt" color="#2b91af">String</font></span><font style="font-size: 12pt"> culture, </font><span><font style="font-size: 12pt" color="#2b91af">BranchesSearchQueryDto</font></span><font style="font-size: 12pt"> queryDto );</font></font></pre>
</blockquote>

<span>L’inghippo è che il vostro scopo è quello di permettere al client di esprimere una possibile query un po’ come se manipolasse direttamente gli “ICriteria” di <a href="http://nhforge.org/" target="_blank">NHibernate</a> che però ovviamente non possono, e non avrebbe senso, varcare i confini del servizio.</span><br>

<span>Quello che potete fare è modellare un dominio per esprimere le query, naturalmente semplificato e pensato per il caso d’uso, fatto ad esempio in questo modo:</span><br>

<span><a href="https://lh3.googleusercontent.com/-o3ILtYO4jCI/T0IsNzxx5hI/AAAAAAAABrA/DN-JeMfQJjo/image_4_4.png"><img style="background-image: none; border-right-width: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://lh6.googleusercontent.com/-GAbihJNRBzE/T0IsM_C8poI/AAAAAAAABq4/VqhtwFOCqgQ/image_thumb_1_4.png" width="244" height="183"></a></span><br>

<span>nulla di trascendentale, triviale direi. Quello che si può notare è che tutti implementano l’interfaccia ICriterionBuilder che è definita così:</span><br>

<blockquote>
  <pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">interface</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">ICriterionBuilder</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">{</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#808080">///</font></span><span><font style="font-size: 12pt" color="#008000"> </font></span><span><font style="font-size: 12pt" color="#808080"><summary></font></span></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#808080">///</font></span><span><font style="font-size: 12pt" color="#008000"> Builds the NHibernate ICriterion that maps this query criteria.</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#808080">///</font></span><span><font style="font-size: 12pt" color="#008000"> </font></span><span><font style="font-size: 12pt" color="#808080"></summary></font></span></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#808080">///</font></span><span><font style="font-size: 12pt" color="#008000"> </font></span><span><font style="font-size: 12pt" color="#808080"><param name=</font></span><span><font style="font-size: 12pt" color="#808080">"criteria"</font></span><span><font style="font-size: 12pt" color="#808080">></font></span><span><font style="font-size: 12pt" color="#008000">The criteria.</font></span><span><font style="font-size: 12pt" color="#808080"></param></font></span></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#808080">///</font></span><span><font style="font-size: 12pt" color="#008000"> </font></span><span><font style="font-size: 12pt" color="#808080"><returns></font></span><span><font style="font-size: 12pt" color="#008000">The new ICriterion.</font></span><span><font style="font-size: 12pt" color="#808080"></returns></font></span></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#2b91af">IEnumerable</font></span><font style="font-size: 12pt"><NHibernate.Criterion.</font><span><font style="font-size: 12pt" color="#2b91af">ICriterion</font></span><font style="font-size: 12pt">> Build( </font><span><font style="font-size: 12pt" color="#2b91af">ICriteria</font></span><font style="font-size: 12pt"> criteria );</font></font><br><font face="Consolas"><font style="font-size: 12pt">}</font></font></pre>
</blockquote>

<span>Il metodo Build prende in pasto i Criteria correnti e ritorna un ICriterion che rappresenta il “Criteria” che ha viaggiato attraverso i confini del servizio.</span><br>

<span><strong>Perchè Build() ha bisogno di un ICriteria?</strong></span><br>

<span>per un motivo abbastanza semplice, un elemento della nostra query potrebbe aver bisogno di un “association path” di esprimere cioè una query ad esempio su un elemento di una collection esposta da un’entità, una join insomma… <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="https://lh6.googleusercontent.com/-zxe3hnAd7Jk/T0IsPFXLCKI/AAAAAAAABrI/JBoQCSk7y0s/wlEmoticon-smile_2_9.png"> questo è ovviamente un problema:</span><br>

<blockquote>
  <span>Voglio cercare tutte le “branch” tra i cui attributi ce ne siano uno che si chiama “Services” e che abbia valore “foo” o valore “bar”</span><br>
</blockquote>

<span>Per il client questa cosa si esprime così:</span><br>

<blockquote>
  <pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt">( </font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> svc = </font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">SearchServiceClient</font></span><font style="font-size: 12pt">() )</font></font><br><font face="Consolas"><font style="font-size: 12pt">{</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> query = </font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">BranchesSearchQueryDto</font></span><font style="font-size: 12pt">()</font></font><br><font face="Consolas"><font style="font-size: 12pt">	{</font></font><br><font face="Consolas"><font style="font-size: 12pt">		AttributesCriteria = </font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">Criteria</font></span><font style="font-size: 12pt">[]</font></font><br><font face="Consolas"><font style="font-size: 12pt">		{</font></font><br><font face="Consolas"><font style="font-size: 12pt">			</font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">DisjunctionCriteria</font></span><font style="font-size: 12pt">()</font></font><br><font face="Consolas"><font style="font-size: 12pt">			{</font></font><br><font face="Consolas"><font style="font-size: 12pt">				OrCriteria = </font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">Criteria</font></span><font style="font-size: 12pt">[]</font></font><br><font face="Consolas"><font style="font-size: 12pt">				{</font></font><br><font face="Consolas"><font style="font-size: 12pt">					</font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">AttributeCriteria</font></span><font style="font-size: 12pt">()</font></font><br><font face="Consolas"><font style="font-size: 12pt">					{ </font></font><br><font face="Consolas"><font style="font-size: 12pt">						Name=</font><span><font style="font-size: 12pt" color="#a31515">"Services"</font></span><font style="font-size: 12pt">, </font></font><br><font face="Consolas"><font style="font-size: 12pt">						QueryText=</font><span><font style="font-size: 12pt" color="#a31515">"foo"</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">					},</font></font><br><font face="Consolas"><font style="font-size: 12pt">					</font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">AttributeCriteria</font></span><font style="font-size: 12pt">()</font></font><br><font face="Consolas"><font style="font-size: 12pt">					{ </font></font><br><font face="Consolas"><font style="font-size: 12pt">						Name=</font><span><font style="font-size: 12pt" color="#a31515">"Services"</font></span><font style="font-size: 12pt">, </font></font><br><font face="Consolas"><font style="font-size: 12pt">						QueryText=</font><span><font style="font-size: 12pt" color="#a31515">"bar"</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">					}</font></font><br><font face="Consolas"><font style="font-size: 12pt">				}</font></font><br><font face="Consolas"><font style="font-size: 12pt">			}</font></font><br><font face="Consolas"><font style="font-size: 12pt">		}</font></font><br><font face="Consolas"><font style="font-size: 12pt">	};</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> result = svc.FindBranchesByQuery( </font><span><font style="font-size: 12pt" color="#a31515">"it-IT"</font></span><font style="font-size: 12pt">, query );</font></font><br><font face="Consolas"><font style="font-size: 12pt">}</font></font></pre>
</blockquote>

<span>Quando vi arriva al servizio quello che avete bisogno di fare è trasformare il tutto in un ICriteria la cosa è però complicata dalla necessità di risalire all’eventuale Alias che è stato attribuito all’association path espresso dagli AttributesCriteria.</span><br>

<span><strong>Si può fare… <cit.></strong></span><br>

<span>In maniera anche decisamente semplice:</span><br>

<blockquote>
  <pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><span><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#0000ff">override</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">IEnumerable</font></span><font style="font-size: 12pt"><NHibernate.Criterion.</font><span><font style="font-size: 12pt" color="#2b91af">ICriterion</font></span><font style="font-size: 12pt">> Build( </font><span><font style="font-size: 12pt" color="#2b91af">ICriteria</font></span><font style="font-size: 12pt"> criteria )</font></font><br><font face="Consolas"><font style="font-size: 12pt">{</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> alias = </font><span><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.GetAttributesAlias( criteria );</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> junction = </font><span><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">Disjunction</font></span><font style="font-size: 12pt">();</font></font><br><font face="Consolas"><font style="font-size: 12pt">	junction.Add( </font><span><font style="font-size: 12pt" color="#2b91af">Restrictions</font></span><font style="font-size: 12pt">.Eq( alias + </font><span><font style="font-size: 12pt" color="#a31515">".Name"</font></span><font style="font-size: 12pt">, </font><span><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.Name ) );</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt">( </font><span><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.Behavior == </font><span><font style="font-size: 12pt" color="#2b91af">CompareBehavior</font></span><font style="font-size: 12pt">.ExactMatch )</font></font><br><font face="Consolas"><font style="font-size: 12pt">	{</font></font><br><font face="Consolas"><font style="font-size: 12pt">		junction.Add( </font><span><font style="font-size: 12pt" color="#2b91af">Restrictions</font></span><font style="font-size: 12pt">.Eq( alias + </font><span><font style="font-size: 12pt" color="#a31515">".Value"</font></span><font style="font-size: 12pt">, </font><span><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.QueryText ) );</font></font><br><font face="Consolas"><font style="font-size: 12pt">	}</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">else</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">	{</font></font><br><font face="Consolas"><font style="font-size: 12pt">		junction.Add( </font><span><font style="font-size: 12pt" color="#2b91af">Restrictions</font></span><font style="font-size: 12pt">.Like( alias + </font><span><font style="font-size: 12pt" color="#a31515">".Value"</font></span><font style="font-size: 12pt">, </font><span><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.QueryText.AsSqlServerKeyword(), </font><span><font style="font-size: 12pt" color="#2b91af">MatchMode</font></span><font style="font-size: 12pt">.Exact ) );</font></font><br><font face="Consolas"><font style="font-size: 12pt">	}</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">yield</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#0000ff">return</font></span><font style="font-size: 12pt"> junction;</font></font><br><font face="Consolas"><font style="font-size: 12pt">}</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><span><font style="font-size: 12pt" color="#2b91af">String</font></span><font style="font-size: 12pt"> GetAttributesAlias( </font><span><font style="font-size: 12pt" color="#2b91af">ICriteria</font></span><font style="font-size: 12pt"> criteria )</font></font><br><font face="Consolas"><font style="font-size: 12pt">{</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">const</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">String</font></span><font style="font-size: 12pt"> alias = </font><span><font style="font-size: 12pt" color="#a31515">"attributes"</font></span><font style="font-size: 12pt">;</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">const</font></span><font style="font-size: 12pt"> </font><span><font style="font-size: 12pt" color="#2b91af">String</font></span><font style="font-size: 12pt"> path = </font><span><font style="font-size: 12pt" color="#a31515">"Attributes"</font></span><font style="font-size: 12pt">;</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> attributeCriteria = criteria.GetCriteriaByPath( path );</font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt">( attributeCriteria == </font><span><font style="font-size: 12pt" color="#0000ff">null</font></span><font style="font-size: 12pt"> )</font></font><br><font face="Consolas"><font style="font-size: 12pt">	{</font></font><br><font face="Consolas"><font style="font-size: 12pt">		criteria.CreateAlias( </font><span><font style="font-size: 12pt" color="#a31515">"Attributes"</font></span><font style="font-size: 12pt">, alias );</font></font><br><font face="Consolas"><font style="font-size: 12pt">		attributeCriteria = criteria.GetCriteriaByPath( path );</font></font><br><font face="Consolas"><font style="font-size: 12pt">	}</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">	</font><span><font style="font-size: 12pt" color="#0000ff">return</font></span><font style="font-size: 12pt"> attributeCriteria.Alias;</font></font><br><font face="Consolas"><font style="font-size: 12pt">}</font></font></pre>
</blockquote>

<span>Il giochetto sta semplicemente nel chiedere al criteria corrente un “sub criteria” sulla base di un path e se non esiste crearlo e infine recuperarne l’alias.</span><br>

<span>Ogni volta che ho a che fare con NHibernate sono sempre più affascinato, prossima tappa i Future<T>() e i FutureValue<T>() per gestire in maniera fighissima la paginazione <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-smilewithtongueout" alt="Smile with tongue out" src="https://lh5.googleusercontent.com/-gxuzc5uZ7ms/T0IsPt1oIgI/AAAAAAAABrM/lBCh1WQLq2A/wlEmoticon-smilewithtongueout_2_4.png"></span><br>

<span>.m</span><br>